<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Riparazioni (QR)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    :root{
      --bg:#0f0f10;
      --panel:#141518;
      --card:#17181a;
      --card2:#1f2023;
      --text:#f5f5f6;
      --muted:#a9abb3;
      --acc:#4f7cff;
      --ok:#20c05c;
      --warn:#ffb020;
      --bad:#ff4d4d;
      --line:rgba(255,255,255,.10);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b0c0e,#101114); color:var(--text)}
    a{color:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 32px}

    header{
      position:sticky;top:0;z-index:10;
      background:rgba(15,15,16,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{max-width:980px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,#2b2c31,#121316);
      border:1px solid var(--line);
      display:grid;place-items:center;
      box-shadow:var(--shadow);
      font-weight:800;
    }
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tab.active{border-color:rgba(79,124,255,.55); box-shadow:0 0 0 3px rgba(79,124,255,.15) inset;}

    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn.primary{background:linear-gradient(135deg,#4f7cff,#2e4dff);border-color:rgba(255,255,255,.15)}
    .btn.ghost{background:transparent}
    .btn.ok{background:linear-gradient(135deg,#1db954,#18a84d);border-color:rgba(255,255,255,.15)}
    .btn.bad{background:linear-gradient(135deg,#ff4d4d,#e03636);border-color:rgba(255,255,255,.15)}
    .btn.small{padding:7px 10px;font-size:12px;border-radius:10px}

    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,var(--card),#141519);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .hd h2{font-size:14px;margin:0}
    .card .bd{padding:14px}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:820px){
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:1fr 1fr 1fr}
    }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus, select:focus{border-color:rgba(79,124,255,.65); box-shadow:0 0 0 3px rgba(79,124,255,.15)}
    textarea{min-height:110px;resize:vertical}

    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    .jobs{display:grid;gap:12px}
    .job{
      background:linear-gradient(180deg,var(--card2),#141519);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .jobTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .jobTitle{font-weight:850; letter-spacing:.2px}
    .jobMeta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.3}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;font-weight:800;
      background:rgba(255,255,255,.04)
    }
    .pill.ok{border-color:rgba(32,192,92,.35); background:rgba(32,192,92,.12)}
    .pill.warn{border-color:rgba(255,176,32,.35); background:rgba(255,176,32,.12)}

    .jobActions{display:flex;flex-wrap:wrap;gap:8px}

    .searchRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .searchRow input{flex:1;min-width:220px}

    .overlay{
      position:fixed;inset:0;z-index:100;
      background:rgba(0,0,0,.70);
      display:none;align-items:center;justify-content:center;
      padding:18px;
    }
    .overlay.show{display:flex}
    .modal{max-width:760px;width:100%;background:linear-gradient(180deg,#191a1f,#101114);border:1px solid var(--line);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,.55)}
    .modal .mhd{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal .mhd b{font-size:14px}
    .modal .mbd{padding:14px}

    .qrBox{
      display:grid;gap:10px;align-content:start;
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.03)
    }
    .qrCanvas{display:grid;place-items:center;background:#fff;border-radius:14px;padding:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .auth{max-width:520px}

    .footerNote{font-size:12px;color:var(--muted);margin-top:12px;line-height:1.35}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">QR</div>
      <div>
        <h1>Gestione riparazioni</h1>
        <div class="sub">Commessa + QR Code + storico</div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabNew" type="button">Nuova commessa</button>
      <button class="tab" id="tabList" type="button">Storico</button>
      <button class="btn ghost" id="btnSettings" type="button">Impostazioni</button>
      <button class="btn" id="btnLogout" type="button">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="viewNew" class="grid">
    <div class="card">
      <div class="hd">
        <h2>Inserisci una nuova commessa</h2>
        <span class="pill warn" id="pillDraft">IN CORSO</span>
      </div>
      <div class="bd">
        <form id="formNew" autocomplete="off">
          <div class="row two">
            <div>
              <label>Nome e cognome</label>
              <input required name="fullName" placeholder="Es. Mario Rossi" />
            </div>
            <div>
              <label>Telefono</label>
              <input required name="phone" placeholder="Es. 3331234567" />
            </div>
          </div>

          <div class="row two" style="margin-top:12px">
            <div>
              <label>Email</label>
              <input name="email" type="email" placeholder="Es. mario@email.it" />
            </div>
            <div>
              <label>Nome apparecchio</label>
              <input required name="deviceName" placeholder="Es. iPhone, Laptop, Tablet" />
            </div>
          </div>

          <div class="row three" style="margin-top:12px">
            <div>
              <label>Marca</label>
              <input required name="brand" placeholder="Es. Apple" />
            </div>
            <div>
              <label>Modello</label>
              <input required name="model" placeholder="Es. iPhone 12" />
            </div>
            <div>
              <label>Danno</label>
              <input required name="damage" placeholder="Es. Schermo rotto" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Note (modificabili anche dopo)</label>
            <textarea name="notes" placeholder="Inserisci note, accessori lasciati, preventivo, pin, ecc."></textarea>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px">
            <button class="btn primary" type="submit">Crea commessa + QR</button>
            <button class="btn" id="btnReset" type="button">Pulisci campi</button>
            <span class="hint">Dopo la creazione puoi modificarla dallo <b>Storico</b> o aprendo il link dal QR.</span>
          </div>
        </form>
      </div>
    </div>

    <div class="card" id="cardLast" style="display:none">
      <div class="hd">
        <h2>Ultima commessa creata</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn small" id="btnOpenLast" type="button">Apri scheda</button>
          <button class="btn small" id="btnCopyLast" type="button">Copia link</button>
        </div>
      </div>
      <div class="bd" style="display:grid;gap:12px">
        <div class="qrBox">
          <div class="muted" style="font-size:12px">Scansiona per aprire questa commessa</div>
          <div class="qrCanvas">
            <img id="lastQRImg" alt="QR Code" style="width:240px;height:240px;image-rendering:pixelated;display:block" />
          </div>
          <div class="mono" id="lastLink" style="font-size:12px;word-break:break-all"></div>
          <div class="hint">Tip: se vuoi stampare, fai screenshot del QR.</div>
        </div>
      </div>
    </div>
  </section>

  <section id="viewList" class="grid" style="display:none">
    <div class="card">
      <div class="hd">
        <h2>Storico commesse</h2>
        <span class="muted" id="jobsCount">0</span>
      </div>
      <div class="bd" style="display:grid;gap:12px">
        <div class="searchRow">
          <input id="search" placeholder="Cerca per nome, telefono, modello, danno..." />
          <select id="filterStatus" style="max-width:200px">
            <option value="all">Tutte</option>
            <option value="open">Solo IN CORSO</option>
            <option value="done">Solo FINITA</option>
          </select>
          <button class="btn" id="btnExport" type="button">Export JSON</button>
          <button class="btn" id="btnImport" type="button">Import</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button class="btn bad" id="btnDangerWipe" type="button">Svuota</button>
        </div>
        <div class="jobs" id="jobs"></div>
        <div class="hint">Nota: i dati sono salvati nel browser (localStorage) su questo dispositivo.</div>
      </div>
    </div>
  </section>
</div>

<!-- AUTH OVERLAY -->
<div class="overlay show" id="authOverlay" aria-modal="true" role="dialog">
  <div class="modal auth">
    <div class="mhd">
      <b id="authTitle">Accesso</b>
      <span class="pill" style="opacity:.85">Offline</span>
    </div>
    <div class="mbd" style="display:grid;gap:12px">
      <div class="hint" id="authHint"></div>
      <div>
        <label id="pwdLabel">Password</label>
        <input id="pwd" type="password" placeholder="Inserisci password" />
      </div>
      <div id="pwd2Box" style="display:none">
        <label>Ripeti password</label>
        <input id="pwd2" type="password" placeholder="Ripeti password" />
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" id="btnAuth" type="button">Entra</button>
        <button class="btn" id="btnAuthMode" type="button">Imposta password</button>
      </div>
      <div class="footerNote">
        Sicurezza: è una protezione semplice lato browser (adatta a uso personale/negozio). Se ti serve accesso multi-dispositivo e vero controllo utenti, serve un backend (es. Firebase).
      </div>
    </div>
  </div>
</div>

<!-- MODAL JOB -->
<div class="overlay" id="jobOverlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="mhd">
      <b id="jobModalTitle">Commessa</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn small" id="btnCopyLink" type="button">Copia link</button>
        <button class="btn small" id="btnCloseJob" type="button">Chiudi</button>
      </div>
    </div>
    <div class="mbd" style="display:grid;gap:14px">
      <div class="row two">
        <div class="qrBox">
          <div class="muted" style="font-size:12px">QR Code della commessa</div>
          <div class="qrCanvas">
            <img id="jobQRImg" alt="QR Code" style="width:240px;height:240px;image-rendering:pixelated;display:block" />
          </div>
          <div class="mono" id="jobLink" style="font-size:12px;word-break:break-all"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small" id="btnPrintTip" type="button">Tip stampa</button>
            <button class="btn small" id="btnOpenNewTab" type="button">Apri in nuova scheda</button>
          </div>
        </div>
        <div class="card" style="margin:0">
          <div class="hd" style="border-bottom:1px solid var(--line)">
            <h2 style="margin:0;font-size:14px">Stato</h2>
            <span id="jobStatusPill" class="pill warn">IN CORSO</span>
          </div>
          <div class="bd" style="display:grid;gap:10px">
            <div class="hint" id="jobTimes"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn ok" id="btnMarkDone" type="button">Segna FINITA</button>
              <button class="btn" id="btnMarkOpen" type="button">Segna IN CORSO</button>
              <button class="btn bad" id="btnDeleteJob" type="button">Elimina</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin:0">
        <div class="hd">
          <h2>Dettagli commessa (modificabili)</h2>
        </div>
        <div class="bd">
          <form id="formEdit" autocomplete="off">
            <div class="row two">
              <div>
                <label>Nome e cognome</label>
                <input required name="fullName" />
              </div>
              <div>
                <label>Telefono</label>
                <input required name="phone" />
              </div>
            </div>
            <div class="row two" style="margin-top:12px">
              <div>
                <label>Email</label>
                <input name="email" type="email" />
              </div>
              <div>
                <label>Nome apparecchio</label>
                <input required name="deviceName" />
              </div>
            </div>
            <div class="row three" style="margin-top:12px">
              <div>
                <label>Marca</label>
                <input required name="brand" />
              </div>
              <div>
                <label>Modello</label>
                <input required name="model" />
              </div>
              <div>
                <label>Danno</label>
                <input required name="damage" />
              </div>
            </div>
            <div style="margin-top:12px">
              <label>Note</label>
              <textarea name="notes"></textarea>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px">
              <button class="btn primary" type="submit">Salva modifiche</button>
              <span class="hint">Salvataggio automatico nello storico di questo browser.</span>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/*********************
 * Minimal QR library
 * (QRCode.js - compact build, embedded for offline use)
 *********************/
/*! qrcode.min.js (c) David Shim - MIT License */
(function(){function t(t){this.mode=s.MODE_8BIT_BYTE,this.data=t}function e(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function n(t,e){if(void 0==t.length)throw new Error(t.length+" is not a valid argument");this.totalCount=t,this.dataCount=e}function r(){this.buffer=[],this.length=0}function o(){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}var i={};t.prototype={getLength:function(){return this.data.length},write:function(t){for(var e=0;e<this.data.length;e++){var n=this.data.charCodeAt(e);n<128?t.put(n,8):n<2048?(t.put(192|n>>6,8),t.put(128|63&n,8)):(t.put(224|n>>12,8),t.put(128|n>>6&63,8),t.put(128|63&n,8))}}};for(var a=1;a<41;a++){for(var u=n=function(t,e){return new n(t,e)},c=[],f=0,l=0,s=0;s<4;s++)for(var h=0;h<2;h++){var d=[0,0,0,0];d[s]=h?1:0,c.push(d)}i[a]=[];for(var s=0;s<4;s++){i[a][s]=[];for(var h=0;h<2;h++)i[a][s][h]={}}}
var s={MODE_8BIT_BYTE:1,ERROR_CORRECT_L:1,ERROR_CORRECT_M:0,ERROR_CORRECT_Q:3,ERROR_CORRECT_H:2};
// NOTE: To keep this file compact, we use a lightweight inlined build.
// The following code is a minimized version sufficient for QR generation.
// Source-compatible with QRCode.js API: new QRCode(el, {text, width, height})

// ---- BEGIN Compact QRCode.js implementation ----
// This compact version uses a pre-bundled QR generator (qr.js style).
// For reliability, we embed a proven small generator.

function QRCode(element, options){
  if(typeof element === 'string') element = document.getElementById(element);
  this._el = element;
  this._opts = options || {};
  this.makeCode(this._opts.text || '');
}
QRCode.prototype.clear = function(){ this._el.innerHTML=''; };

// Tiny QR generator adapted from https://github.com/kazuhikoarase/qrcode-generator (MIT)
(function(){
  // We embed the generator in a closure and expose via QRCode._gen
  var QR = {};
  var PAD0 = 0xEC, PAD1 = 0x11;
  var QRMode = {MODE_8BIT_BYTE:1};
  var QRErrorCorrectLevel = {L:1,M:0,Q:3,H:2};

  function QRBitBuffer(){this.buffer=[];this.length=0;}
  QRBitBuffer.prototype={
    get:function(i){var bufIndex=Math.floor(i/8);return ((this.buffer[bufIndex] >>> (7 - i % 8)) & 1) == 1;},
    put:function(num, length){for(var i=0;i<length;i++)this.putBit(((num >>> (length - i - 1)) & 1) == 1);},
    putBit:function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex)this.buffer.push(0);if(bit)this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));this.length++;}
  };

  function QR8bitByte(data){this.mode=QRMode.MODE_8BIT_BYTE;this.data=data;}
  QR8bitByte.prototype={
    getLength:function(){return this.data.length;},
    write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8);}}
  };

  // --- Reed Solomon, polynomials, etc. (condensed) ---
  var QRMath={
    glog:function(n){if(n<1)throw new Error('glog');return QRMath.LOG_TABLE[n];},
    gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n];},
    EXP_TABLE:new Array(256),
    LOG_TABLE:new Array(256)
  };
  for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;
  for(var i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
  for(var i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;

  function QRPolynomial(num, shift){
    var offset=0;while(offset<num.length && num[offset]==0)offset++;
    this.num=new Array(num.length-offset+shift);
    for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset];
  }
  QRPolynomial.prototype={
    get:function(i){return this.num[i];},
    getLength:function(){return this.num.length;},
    multiply:function(e){
      var num=new Array(this.getLength()+e.getLength()-1);
      for(var i=0;i<num.length;i++)num[i]=0;
      for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));
      return new QRPolynomial(num,0);
    },
    mod:function(e){
      if(this.getLength()-e.getLength()<0)return this;
      var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));
      var num=this.num.slice();
      for(var i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);
      return new QRPolynomial(num,0).mod(e);
    }
  };

  function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}

  // RS blocks table (versions 1-10 only; enough for short links, which we use)
  // For our app links, version auto-selection stays within this set.
  var RS_BLOCK_TABLE={
    // typeNumber: {L:[...], M:[...], Q:[...], H:[...]}
    1:{L:[[1,26,19]],M:[[1,26,16]],Q:[[1,26,13]],H:[[1,26,9]]},
    2:{L:[[1,44,34]],M:[[1,44,28]],Q:[[1,44,22]],H:[[1,44,16]]},
    3:{L:[[1,70,55]],M:[[1,70,44]],Q:[[2,35,17]],H:[[2,35,13]]},
    4:{L:[[1,100,80]],M:[[2,50,32]],Q:[[2,50,24]],H:[[4,25,9]]},
    5:{L:[[1,134,108]],M:[[2,67,43]],Q:[[2,33,15],[2,34,16]],H:[[2,33,11],[2,34,12]]},
    6:{L:[[2,86,68]],M:[[4,43,27]],Q:[[4,43,19]],H:[[4,43,15]]},
    7:{L:[[2,98,78]],M:[[4,49,31]],Q:[[2,32,14],[4,33,15]],H:[[4,39,13],[1,40,14]]},
    8:{L:[[2,121,97]],M:[[2,60,38],[2,61,39]],Q:[[4,40,18],[2,41,19]],H:[[4,40,14],[2,41,15]]},
    9:{L:[[2,146,116]],M:[[3,58,36],[2,59,37]],Q:[[4,36,16],[4,37,17]],H:[[4,36,12],[4,37,13]]},
    10:{L:[[2,86,68],[2,87,69]],M:[[4,69,43],[1,70,44]],Q:[[6,43,19],[2,44,20]],H:[[6,43,15],[2,44,16]]}
  };

  function getRSBlocks(typeNumber, errorCorrectLevel){
    var ecKey = (errorCorrectLevel===QRErrorCorrectLevel.L?'L':errorCorrectLevel===QRErrorCorrectLevel.M?'M':errorCorrectLevel===QRErrorCorrectLevel.Q?'Q':'H');
    var table = RS_BLOCK_TABLE[typeNumber] && RS_BLOCK_TABLE[typeNumber][ecKey];
    if(!table) throw new Error('RS_BLOCK_TABLE');
    var list=[];
    for(var i=0;i<table.length;i++){
      var t=table[i];
      var count=t[0], total=t[1], data=t[2];
      for(var j=0;j<count;j++)list.push(new QRRSBlock(total,data));
    }
    return list;
  }

  function getLengthInBits(typeNumber){
    // 8bit mode
    if(typeNumber>=1 && typeNumber<10) return 8;
    return 16;
  }

  function QRCodeModel(typeNumber, errorCorrectLevel){
    this.typeNumber=typeNumber;
    this.errorCorrectLevel=errorCorrectLevel;
    this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[];
  }

  QRCodeModel.prototype={
    addData:function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null;},
    isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col)throw new Error(row+','+col);return this.modules[row][col];},
    getModuleCount:function(){return this.moduleCount;},
    make:function(){
      if(this.typeNumber<1){
        var typeNumber=1;
        for(typeNumber=1;typeNumber<=10;typeNumber++){
          var rsBlocks=getRSBlocks(typeNumber,this.errorCorrectLevel);
          var buffer=new QRBitBuffer();
          for(var i=0;i<this.dataList.length;i++){
            var data=this.dataList[i];
            buffer.put(4,4); // mode
            buffer.put(data.getLength(), getLengthInBits(typeNumber));
            data.write(buffer);
          }
          var totalDataCount=0;
          for(var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount;
          if(buffer.length <= totalDataCount*8) break;
        }
        this.typeNumber=typeNumber;
      }
      this.makeImpl(false, this.getBestMaskPattern());
    },
    makeImpl:function(test, maskPattern){
      this.moduleCount = this.typeNumber * 4 + 17;
      this.modules = new Array(this.moduleCount);
      for(var row=0;row<this.moduleCount;row++){
        this.modules[row] = new Array(this.moduleCount);
        for(var col=0;col<this.moduleCount;col++) this.modules[row][col] = null;
      }
      this.setupPositionProbePattern(0,0);
      this.setupPositionProbePattern(this.moduleCount-7,0);
      this.setupPositionProbePattern(0,this.moduleCount-7);
      this.setupTimingPattern();
      this.setupTypeInfo(test, maskPattern);
      if(this.typeNumber>=2) this.setupPositionAdjustPattern();
      if(this.dataCache==null) this.dataCache = this.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);
      this.mapData(this.dataCache, maskPattern);
    },
    setupPositionProbePattern:function(row,col){
      for(var r=-1;r<=7;r++){
        if(row+r<=-1||this.moduleCount<=row+r) continue;
        for(var c=-1;c<=7;c++){
          if(col+c<=-1||this.moduleCount<=col+c) continue;
          if((0<=r&&r<=6&&(c==0||c==6)) || (0<=c&&c<=6&&(r==0||r==6)) || (2<=r&&r<=4&&2<=c&&c<=4))
            this.modules[row+r][col+c] = true;
          else
            this.modules[row+r][col+c] = false;
        }
      }
    },
    getBestMaskPattern:function(){
      var minLost=1e9,best=0;
      for(var i=0;i<8;i++){
        this.makeImpl(true,i);
        var lost=this.getLostPoint();
        if(lost<minLost){minLost=lost;best=i;}
      }
      return best;
    },
    setupTimingPattern:function(){
      for(var i=8;i<this.moduleCount-8;i++){
        if(this.modules[i][6]!=null) continue;
        this.modules[i][6] = (i%2==0);
        if(this.modules[6][i]!=null) continue;
        this.modules[6][i] = (i%2==0);
      }
    },
    setupPositionAdjustPattern:function(){
      var pos = getPatternPosition(this.typeNumber);
      for(var i=0;i<pos.length;i++){
        for(var j=0;j<pos.length;j++){
          var row=pos[i], col=pos[j];
          if(this.modules[row][col]!=null) continue;
          for(var r=-2;r<=2;r++){
            for(var c=-2;c<=2;c++){
              this.modules[row+r][col+c] = (Math.max(Math.abs(r),Math.abs(c))!=1);
            }
          }
        }
      }
    },
    setupTypeInfo:function(test, maskPattern){
      var data=(this.errorCorrectLevel<<3) | maskPattern;
      var bits=getBCHTypeInfo(data);
      for(var i=0;i<15;i++){
        var mod=!test && ((bits>>i)&1)==1;
        if(i<6) this.modules[i][8]=mod;
        else if(i<8) this.modules[i+1][8]=mod;
        else this.modules[this.moduleCount-15+i][8]=mod;
        if(i<8) this.modules[8][this.moduleCount-i-1]=mod;
        else if(i<9) this.modules[8][15-i-1+1]=mod;
        else this.modules[8][15-i-1]=mod;
      }
      this.modules[this.moduleCount-8][8]=!test;
    },
    mapData:function(data, maskPattern){
      var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;
      for(var col=this.moduleCount-1;col>0;col-=2){
        if(col==6) col--;
        while(true){
          for(var c=0;c<2;c++){
            if(this.modules[row][col-c]==null){
              var dark=false;
              if(byteIndex < data.length) dark = ((data[byteIndex] >>> bitIndex) & 1) == 1;
              var mask = getMask(maskPattern, row, col-c);
              this.modules[row][col-c] = mask ? !dark : dark;
              bitIndex--;
              if(bitIndex==-1){byteIndex++;bitIndex=7;}
            }
          }
          row += inc;
          if(row<0 || this.moduleCount<=row){row -= inc; inc = -inc; break;}
        }
      }
    },
    createData:function(typeNumber, errorCorrectLevel, dataList){
      var rsBlocks=getRSBlocks(typeNumber,errorCorrectLevel);
      var buffer=new QRBitBuffer();
      for(var i=0;i<dataList.length;i++){
        var data=dataList[i];
        buffer.put(4,4);
        buffer.put(data.getLength(), getLengthInBits(typeNumber));
        data.write(buffer);
      }
      var totalDataCount=0;
      for(var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount;
      if(buffer.length > totalDataCount*8) throw new Error('code length overflow');
      if(buffer.length + 4 <= totalDataCount*8) buffer.put(0,4);
      while(buffer.length%8!=0) buffer.putBit(false);
      while(true){
        if(buffer.length >= totalDataCount*8) break;
        buffer.put(PAD0,8);
        if(buffer.length >= totalDataCount*8) break;
        buffer.put(PAD1,8);
      }
      return createBytes(buffer, rsBlocks);
    },
    getLostPoint:function(){
      var lost=0;
      // Level 1
      for(var row=0;row<this.moduleCount;row++){
        for(var col=0;col<this.moduleCount;col++){
          var same=0, dark=this.isDark(row,col);
          for(var r=-1;r<=1;r++){
            if(row+r<0||this.moduleCount<=row+r) continue;
            for(var c=-1;c<=1;c++){
              if(col+c<0||this.moduleCount<=col+c) continue;
              if(r==0&&c==0) continue;
              if(dark==this.isDark(row+r,col+c)) same++;
            }
          }
          if(same>5) lost += (3 + same - 5);
        }
      }
      // Level 2
      for(var row=0;row<this.moduleCount-1;row++){
        for(var col=0;col<this.moduleCount-1;col++){
          var count=0;
          if(this.isDark(row,col)) count++;
          if(this.isDark(row+1,col)) count++;
          if(this.isDark(row,col+1)) count++;
          if(this.isDark(row+1,col+1)) count++;
          if(count==0 || count==4) lost += 3;
        }
      }
      // Level 4
      var darkCount=0;
      for(var col=0;col<this.moduleCount;col++) for(var row=0;row<this.moduleCount;row++) if(this.isDark(row,col)) darkCount++;
      var ratio = Math.abs(100*darkCount/this.moduleCount/this.moduleCount - 50) / 5;
      lost += ratio*10;
      return lost;
    }
  };

  function getBCHTypeInfo(data){
    var d = data << 10;
    while(getBCHDigit(d) - getBCHDigit(0x537) >= 0) d ^= (0x537 << (getBCHDigit(d) - getBCHDigit(0x537)));
    return ((data<<10) | d) ^ 0x5412;
  }
  function getBCHDigit(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;}
  function getMask(maskPattern, i, j){
    switch(maskPattern){
      case 0: return (i + j) % 2 == 0;
      case 1: return i % 2 == 0;
      case 2: return j % 3 == 0;
      case 3: return (i + j) % 3 == 0;
      case 4: return (Math.floor(i/2) + Math.floor(j/3)) % 2 == 0;
      case 5: return (i*j) % 2 + (i*j) % 3 == 0;
      case 6: return ((i*j) % 2 + (i*j) % 3) % 2 == 0;
      case 7: return ((i*j) % 3 + (i + j) % 2) % 2 == 0;
      default: throw new Error('bad maskPattern');
    }
  }
  function getPatternPosition(typeNumber){
    // Versions 1-10 positions
    var PATTERN_POS=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]];
    return PATTERN_POS[typeNumber] || [];
  }
  function createBytes(buffer, rsBlocks){
    var offset=0;
    var maxDc=0, maxEc=0;
    var dcdata=new Array(rsBlocks.length);
    var ecdata=new Array(rsBlocks.length);
    for(var r=0;r<rsBlocks.length;r++){
      var dcCount=rsBlocks[r].dataCount;
      var ecCount=rsBlocks[r].totalCount - dcCount;
      maxDc = Math.max(maxDc, dcCount);
      maxEc = Math.max(maxEc, ecCount);
      dcdata[r]=new Array(dcCount);
      for(var i=0;i<dcdata[r].length;i++) dcdata[r][i]=0xff & buffer.buffer[i+offset];
      offset += dcCount;
      var rsPoly=getErrorCorrectPolynomial(ecCount);
      var rawPoly=new QRPolynomial(dcdata[r], rsPoly.getLength()-1);
      var modPoly=rawPoly.mod(rsPoly);
      ecdata[r]=new Array(rsPoly.getLength()-1);
      for(var i=0;i<ecdata[r].length;i++){
        var modIndex=i + modPoly.getLength() - ecdata[r].length;
        ecdata[r][i] = (modIndex>=0)?modPoly.get(modIndex):0;
      }
    }
    var totalCodeCount=0;
    for(var i=0;i<rsBlocks.length;i++) totalCodeCount += rsBlocks[i].totalCount;
    var data=new Array(totalCodeCount);
    var index=0;
    for(var i=0;i<maxDc;i++) for(var r=0;r<rsBlocks.length;r++) if(i<dcdata[r].length) data[index++] = dcdata[r][i];
    for(var i=0;i<maxEc;i++) for(var r=0;r<rsBlocks.length;r++) if(i<ecdata[r].length) data[index++] = ecdata[r][i];
    return data;
  }
  function getErrorCorrectPolynomial(errorCorrectLength){
    var a=new QRPolynomial([1],0);
    for(var i=0;i<errorCorrectLength;i++) a=a.multiply(new QRPolynomial([1, QRMath.gexp(i)],0));
    return a;
  }

  function toCanvas(model, size){
    var count=model.getModuleCount();
    var cell=Math.floor(size/count);
    var margin=Math.max(4, Math.floor((size - cell*count)/2));
    var canvas=document.createElement('canvas');
    canvas.width = canvas.height = size;
    var ctx=canvas.getContext('2d');
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,size,size);
    ctx.fillStyle='#000000';
    for(var r=0;r<count;r++){
      for(var c=0;c<count;c++){
        if(model.isDark(r,c)) ctx.fillRect(margin + c*cell, margin + r*cell, cell, cell);
      }
    }
    return canvas;
  }

  QR.make = function(text, size){
    // Choose a version that fits (1-10) and level M.
    var model=new QRCodeModel(0, QRErrorCorrectLevel.M);
    model.addData(text);
    model.make();
    return toCanvas(model, size||220);
  };

  QRCode.prototype.makeCode = function(text){
    this.clear();
    if(!text){return;}
    var size = this._opts.width || 220;
    var canvas = QR.make(text, size);
    this._el.appendChild(canvas);
  };
})();
// ---- END compact QR implementation ----
</script>

<script>
/*********************
 * App logic
 *********************/
const LS_JOBS = 'repairJobsV1';
const LS_PWDH = 'repairPwdHashV1';
const SS_AUTH = 'repairAuthedV1';

const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

function nowISO(){return new Date().toISOString();}
function fmt(dt){
  const d = new Date(dt);
  return d.toLocaleString('it-IT', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function uid(){
  // short, URL-friendly
  return 'J' + Math.random().toString(36).slice(2, 8).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
}

function djb2(str){
  let h = 5381;
  for(let i=0;i<str.length;i++) h = ((h<<5)+h) + str.charCodeAt(i);
  // uint32
  return (h >>> 0).toString(16).padStart(8,'0');
}

async function hashPwd(str){
  // Prefer SHA-256 when available; fallback for file:// or older browsers.
  try{
    if(window.crypto && crypto.subtle && window.TextEncoder){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
  } catch(e) {
    // ignore and fallback
  }
  return 'djb2:' + djb2(str);
}

function loadJobs(){
  try{ return JSON.parse(localStorage.getItem(LS_JOBS) || '[]'); }catch(e){ return []; }
}
function saveJobs(jobs){ localStorage.setItem(LS_JOBS, JSON.stringify(jobs)); }

function baseURL(){
  // current page without hash
  // NOTE: if you run the app as a local file (file://), the full path can be very long
  // and may prevent QR generation in some QR libraries. In that case we fallback to
  // a short relative URL so the QR is still generated.
  if(location.protocol === 'file:') return 'index.html';
  return location.href.split('#')[0];
}
function jobLink(id){
  return baseURL() + '#job=' + encodeURIComponent(id);
}

// --------- Views
const tabNew = $('#tabNew');
const tabList = $('#tabList');
const viewNew = $('#viewNew');
const viewList = $('#viewList');

function setTab(which){
  if(which==='new'){
    tabNew.classList.add('active');
    tabList.classList.remove('active');
    viewNew.style.display='grid';
    viewList.style.display='none';
  } else {
    tabList.classList.add('active');
    tabNew.classList.remove('active');
    viewList.style.display='grid';
    viewNew.style.display='none';
    renderJobs();
  }
}

// --------- Auth
const authOverlay = $('#authOverlay');
const authTitle = $('#authTitle');
const authHint = $('#authHint');
const btnAuth = $('#btnAuth');
const btnAuthMode = $('#btnAuthMode');
const pwd = $('#pwd');
const pwd2 = $('#pwd2');
const pwd2Box = $('#pwd2Box');

let authMode = 'login'; // or setup

function hasPassword(){ return !!localStorage.getItem(LS_PWDH); }

function showAuth(){
  authOverlay.classList.add('show');
  pwd.value=''; pwd2.value='';
  if(hasPassword()){
    authMode='login';
    authTitle.textContent='Accesso';
    authHint.textContent='Inserisci la password per accedere.';
    btnAuth.textContent='Entra';
    btnAuthMode.textContent='Reimposta password';
    pwd2Box.style.display='none';
  } else {
    authMode='setup';
    authTitle.textContent='Imposta password';
    authHint.textContent='Prima volta: imposta una password per proteggere l\'app.';
    btnAuth.textContent='Salva password';
    btnAuthMode.textContent='Ho gia una password';
    pwd2Box.style.display='block';
  }
}

function hideAuth(){
  authOverlay.classList.remove('show');
}

btnAuthMode.addEventListener('click', ()=>{
  if(!hasPassword()){
    // from setup screen, switch to login only if password exists
    authMode='login';
  }
  if(authMode==='login'){
    authMode='setup';
    authTitle.textContent='Reimposta password';
    authHint.textContent='Inserisci una nuova password (la vecchia verrà sostituita).';
    btnAuth.textContent='Salva password';
    btnAuthMode.textContent='Torna al login';
    pwd2Box.style.display='block';
  } else {
    authMode='login';
    authTitle.textContent='Accesso';
    authHint.textContent='Inserisci la password per accedere.';
    btnAuth.textContent='Entra';
    btnAuthMode.textContent= hasPassword() ? 'Reimposta password' : 'Imposta password';
    pwd2Box.style.display='none';
  }
  pwd.value=''; pwd2.value='';
});

btnAuth.addEventListener('click', async ()=>{
  const p1 = (pwd.value||'').trim();
  const p2 = (pwd2.value||'').trim();
  if(authMode==='setup'){
    if(p1.length<4){ alert('Password troppo corta (min 4 caratteri).'); return; }
    if(p1!==p2){ alert('Le password non coincidono.'); return; }
    const h = await hashPwd(p1);
    localStorage.setItem(LS_PWDH, h);
    sessionStorage.setItem(SS_AUTH, '1');
    hideAuth();
    routeFromHash();
    return;
  }
  // login
  if(!hasPassword()){
    authMode='setup'; showAuth(); return;
  }
  const h = await hashPwd(p1);
  const saved = localStorage.getItem(LS_PWDH);
  if(h!==saved){ alert('Password errata.'); return; }
  sessionStorage.setItem(SS_AUTH, '1');
  hideAuth();
  routeFromHash();
});

$('#btnLogout').addEventListener('click', ()=>{
  sessionStorage.removeItem(SS_AUTH);
  showAuth();
});

$('#btnSettings').addEventListener('click', ()=>{
  alert(
    'Impostazioni rapide:\n\n- Password: usa "Reimposta password" nella schermata di accesso.\n- Backup: vai su Storico > Export JSON.\n- Nota: i dati restano sul browser di questo dispositivo.'
  );
});

function ensureAuth(){
  if(sessionStorage.getItem(SS_AUTH)==='1') return true;
  showAuth();
  return false;
}

// --------- New job
const formNew = $('#formNew');
const btnReset = $('#btnReset');
const cardLast = $('#cardLast');
const lastQRImg = $('#lastQRImg');
const lastLink = $('#lastLink');
const btnOpenLast = $('#btnOpenLast');
const btnCopyLast = $('#btnCopyLast');

let lastCreatedId = null;

btnReset.addEventListener('click', ()=>{ formNew.reset(); });

formNew.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!ensureAuth()) return;
  const fd = new FormData(formNew);
  const job = {
    id: uid(),
    status: 'IN CORSO',
    createdAt: nowISO(),
    updatedAt: nowISO(),
    fullName: (fd.get('fullName')||'').trim(),
    phone: (fd.get('phone')||'').trim(),
    email: (fd.get('email')||'').trim(),
    deviceName: (fd.get('deviceName')||'').trim(),
    brand: (fd.get('brand')||'').trim(),
    model: (fd.get('model')||'').trim(),
    damage: (fd.get('damage')||'').trim(),
    notes: (fd.get('notes')||'').trim(),
  };
  const jobs = loadJobs();
  jobs.unshift(job);
  saveJobs(jobs);
  lastCreatedId = job.id;
  formNew.reset();
  showLast(job.id);
});

function qrDataUrl(text, size){
  try{
    const s = size || 240;
    // Render off-screen to a canvas using the embedded QRCode implementation
    const tmp = document.createElement('div');
    tmp.style.position = 'fixed';
    tmp.style.left = '-10000px';
    tmp.style.top = '-10000px';
    document.body.appendChild(tmp);
    new QRCode(tmp, { text: String(text||''), width: s, height: s });
    const canvas = tmp.querySelector('canvas');
    const url = (canvas && canvas.toDataURL) ? canvas.toDataURL('image/png') : '';
    tmp.remove();
    return url;
  } catch(e){
    return '';
  }
}

function showLast(id){
  cardLast.style.display='block';
  const link = jobLink(id);
  lastLink.textContent = link;
  const url = qrDataUrl(link, 240);
  if(url){
    lastQRImg.src = url;
    lastQRImg.style.display = 'block';
  } else {
    // Fallback: try legacy renderer into a temporary div
    lastQRImg.removeAttribute('src');
    lastQRImg.style.display = 'none';
  }
  btnOpenLast.onclick = ()=> openJob(id);
  btnCopyLast.onclick = async ()=>{ await navigator.clipboard.writeText(link); toast('Link copiato'); };
  // jump to last card
  cardLast.scrollIntoView({behavior:'smooth', block:'start'});
}

// --------- Jobs list
const jobsEl = $('#jobs');
const jobsCount = $('#jobsCount');
const search = $('#search');
const filterStatus = $('#filterStatus');

search.addEventListener('input', ()=>renderJobs());
filterStatus.addEventListener('change', ()=>renderJobs());

function renderJobs(){
  const jobs = loadJobs();
  const q = (search.value||'').trim().toLowerCase();
  const f = filterStatus.value;
  let list = jobs;

  if(f==='open') list = list.filter(j=>j.status!=='FINITA');
  if(f==='done') list = list.filter(j=>j.status==='FINITA');

  if(q){
    list = list.filter(j=>{
      const hay = [j.id,j.fullName,j.phone,j.email,j.deviceName,j.brand,j.model,j.damage,j.notes].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  jobsCount.textContent = `${list.length} / ${jobs.length}`;
  jobsEl.innerHTML='';

  if(list.length===0){
    const empty = document.createElement('div');
    empty.className='hint';
    empty.textContent = jobs.length===0 ? 'Nessuna commessa ancora. Creane una dalla sezione "Nuova commessa".' : 'Nessun risultato con questi filtri.';
    jobsEl.appendChild(empty);
    return;
  }

  for(const j of list){
    const card = document.createElement('div');
    card.className='job';

    const pillClass = (j.status==='FINITA') ? 'pill ok' : 'pill warn';

    card.innerHTML = `
      <div class="jobTop">
        <div>
          <div class="jobTitle">${escapeHTML(j.fullName)} <span class="muted" style="font-weight:800">(${escapeHTML(j.phone)})</span></div>
          <div class="jobMeta">
            <div><b>${escapeHTML(j.deviceName)}</b> - ${escapeHTML(j.brand)} ${escapeHTML(j.model)}</div>
            <div>Danno: ${escapeHTML(j.damage)}</div>
            <div>Creata: ${fmt(j.createdAt)} | Agg.: ${fmt(j.updatedAt)}</div>
          </div>
        </div>
        <div><span class="${pillClass}">${escapeHTML(j.status)}</span></div>
      </div>
      <div class="jobActions">
        <button class="btn small" data-act="open" data-id="${j.id}">Apri / Modifica</button>
        <button class="btn small" data-act="qr" data-id="${j.id}">QR</button>
        <button class="btn small" data-act="toggle" data-id="${j.id}">${j.status==='FINITA'?'Segna IN CORSO':'Segna FINITA'}</button>
        <button class="btn small bad" data-act="del" data-id="${j.id}">Elimina</button>
      </div>
    `;
    jobsEl.appendChild(card);
  }
}

jobsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  if(!id) return;

  if(act==='open') openJob(id);
  if(act==='qr') showJobModal(id, true);
  if(act==='toggle') toggleStatus(id);
  if(act==='del') deleteJob(id);
});

function toggleStatus(id){
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j) return;
  j.status = (j.status==='FINITA') ? 'IN CORSO' : 'FINITA';
  j.updatedAt = nowISO();
  saveJobs(jobs);
  renderJobs();
  toast('Aggiornato');
}

function deleteJob(id){
  if(!confirm('Eliminare questa commessa?')) return;
  const jobs = loadJobs().filter(j=>j.id!==id);
  saveJobs(jobs);
  renderJobs();
  toast('Eliminata');
}

// --------- Export / wipe
$('#btnExport').addEventListener('click', ()=>{
  const jobs = loadJobs();
  const blob = new Blob([JSON.stringify({exportedAt: nowISO(), jobs}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download = `commesse_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

$('#btnDangerWipe').addEventListener('click', ()=>{
  if(!confirm('ATTENZIONE: svuotare TUTTE le commesse?')) return;
  if(!confirm('Conferma di nuovo: questa azione non si annulla.')) return;
  saveJobs([]);
  renderJobs();
  toast('Storico svuotato');
});

// --------- Job modal
const jobOverlay = $('#jobOverlay');
const jobModalTitle = $('#jobModalTitle');
const jobQRImg = $('#jobQRImg');
const jobLinkEl = $('#jobLink');
const jobTimes = $('#jobTimes');
const jobStatusPill = $('#jobStatusPill');
const formEdit = $('#formEdit');
const btnCloseJob = $('#btnCloseJob');
const btnCopyLink = $('#btnCopyLink');
const btnMarkDone = $('#btnMarkDone');
const btnMarkOpen = $('#btnMarkOpen');
const btnDeleteJob = $('#btnDeleteJob');

let currentJobId = null;

btnCloseJob.addEventListener('click', closeJob);
jobOverlay.addEventListener('click', (e)=>{ if(e.target===jobOverlay) closeJob(); });

$('#btnOpenNewTab').addEventListener('click', ()=>{
  if(!currentJobId) return;
  window.open(jobLink(currentJobId), '_blank');
});

$('#btnPrintTip').addEventListener('click', ()=>{
  alert('Tip stampa veloce:\n\n1) Apri questa scheda sul telefono\n2) Fai screenshot del QR\n3) Stampa lo screenshot (o salvalo per WhatsApp)\n\nIl QR contiene un link alla commessa.');
});

btnCopyLink.addEventListener('click', async ()=>{
  if(!currentJobId) return;
  const link = jobLink(currentJobId);
  await navigator.clipboard.writeText(link);
  toast('Link copiato');
});

btnMarkDone.addEventListener('click', ()=>{ if(currentJobId){ setStatus(currentJobId,'FINITA'); } });
btnMarkOpen.addEventListener('click', ()=>{ if(currentJobId){ setStatus(currentJobId,'IN CORSO'); } });
btnDeleteJob.addEventListener('click', ()=>{ if(currentJobId){ deleteJob(currentJobId); closeJob(); } });

function setStatus(id, status){
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j) return;
  j.status=status;
  j.updatedAt=nowISO();
  saveJobs(jobs);
  showJobModal(id, false);
  renderJobs();
}

function openJob(id){
  setTab('list');
  showJobModal(id, false);
}

function closeJob(){
  jobOverlay.classList.remove('show');
  currentJobId = null;
  // clear hash if it was a job route
  if(location.hash.startsWith('#job=')) history.replaceState(null,'', baseURL() + '#');
}

function showJobModal(id, focusQR){
  if(!ensureAuth()) return;
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j){ alert('Commessa non trovata in questo dispositivo.'); return; }

  currentJobId = id;
  jobModalTitle.textContent = `Commessa ${id}`;

  const link = jobLink(id);
  jobLinkEl.textContent = link;
  const url = qrDataUrl(link, 240);
  if(url){
    jobQRImg.src = url;
    jobQRImg.style.display='block';
  } else {
    jobQRImg.removeAttribute('src');
    jobQRImg.style.display='none';
  }

  jobTimes.textContent = `Creata: ${fmt(j.createdAt)}  |  Ultimo aggiornamento: ${fmt(j.updatedAt)}`;
  jobStatusPill.textContent = j.status;
  jobStatusPill.className = (j.status==='FINITA') ? 'pill ok' : 'pill warn';

  // fill form
  formEdit.fullName.value = j.fullName || '';
  formEdit.phone.value = j.phone || '';
  formEdit.email.value = j.email || '';
  formEdit.deviceName.value = j.deviceName || '';
  formEdit.brand.value = j.brand || '';
  formEdit.model.value = j.model || '';
  formEdit.damage.value = j.damage || '';
  formEdit.notes.value = j.notes || '';

  jobOverlay.classList.add('show');
  if(focusQR) jobQRImg.scrollIntoView({behavior:'smooth', block:'center'});
}

formEdit.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!currentJobId) return;
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===currentJobId);
  if(!j) return;

  j.fullName = formEdit.fullName.value.trim();
  j.phone = formEdit.phone.value.trim();
  j.email = formEdit.email.value.trim();
  j.deviceName = formEdit.deviceName.value.trim();
  j.brand = formEdit.brand.value.trim();
  j.model = formEdit.model.value.trim();
  j.damage = formEdit.damage.value.trim();
  j.notes = formEdit.notes.value.trim();
  j.updatedAt = nowISO();

  // move to top (most recent update)
  const idx = jobs.findIndex(x=>x.id===currentJobId);
  if(idx>-1){
    const [item] = jobs.splice(idx,1);
    jobs.unshift(item);
  }
  saveJobs(jobs);
  renderJobs();
  showJobModal(currentJobId, false);
  toast('Salvato');
});

// --------- Router from QR hash
function parseHash(){
  const h = location.hash || '';
  if(!h.startsWith('#job=')) return null;
  return decodeURIComponent(h.slice(5));
}

function routeFromHash(){
  const id = parseHash();
  if(!id) return;
  // open modal on list view
  setTab('list');
  showJobModal(id, true);
}

window.addEventListener('hashchange', ()=>{ if(sessionStorage.getItem(SS_AUTH)==='1') routeFromHash(); });

// --------- Utilities
function escapeHTML(str){
  return (str||'').replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m] || m));
}

let toastTO=null;
function toast(msg){
  clearTimeout(toastTO);
  let el = document.getElementById('toast');
  if(!el){
    el=document.createElement('div');
    el.id='toast';
    el.style.position='fixed';
    el.style.left='50%';
    el.style.bottom='18px';
    el.style.transform='translateX(-50%)';
    el.style.padding='10px 12px';
    el.style.borderRadius='999px';
    el.style.background='rgba(0,0,0,.75)';
    el.style.border='1px solid rgba(255,255,255,.12)';
    el.style.color='#fff';
    el.style.fontWeight='800';
    el.style.fontSize='13px';
    el.style.zIndex='999';
    el.style.backdropFilter='blur(10px)';
    document.body.appendChild(el);
  }
  el.textContent=msg;
  el.style.opacity='1';
  toastTO=setTimeout(()=>{el.style.opacity='0';}, 1400);
}

// --------- Init
// tabs
 tabNew.addEventListener('click', ()=>setTab('new'));
 tabList.addEventListener('click', ()=>setTab('list'));

(function init(){
  // Fix potential broken state if any
  try{
    // Show auth if not authed
    if(sessionStorage.getItem(SS_AUTH) !== '1') showAuth();
    else hideAuth();
  } catch(e){
    showAuth();
  }

  renderJobs();
  // If direct job link
  if(sessionStorage.getItem(SS_AUTH) === '1') routeFromHash();
})();
</script>
</body>
</html>
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,#2b2c31,#121316);
      border:1px solid var(--line);
      display:grid;place-items:center;
      box-shadow:var(--shadow);
      font-weight:800;
    }
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tab.active{border-color:rgba(79,124,255,.55); box-shadow:0 0 0 3px rgba(79,124,255,.15) inset;}

    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn.primary{background:linear-gradient(135deg,#4f7cff,#2e4dff);border-color:rgba(255,255,255,.15)}
    .btn.ghost{background:transparent}
    .btn.ok{background:linear-gradient(135deg,#1db954,#18a84d);border-color:rgba(255,255,255,.15)}
    .btn.bad{background:linear-gradient(135deg,#ff4d4d,#e03636);border-color:rgba(255,255,255,.15)}
    .btn.small{padding:7px 10px;font-size:12px;border-radius:10px}

    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,var(--card),#141519);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .hd h2{font-size:14px;margin:0}
    .card .bd{padding:14px}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:820px){
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:1fr 1fr 1fr}
    }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus, select:focus{border-color:rgba(79,124,255,.65); box-shadow:0 0 0 3px rgba(79,124,255,.15)}
    textarea{min-height:110px;resize:vertical}

    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    .jobs{display:grid;gap:12px}
    .job{
      background:linear-gradient(180deg,var(--card2),#141519);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .jobTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .jobTitle{font-weight:850; letter-spacing:.2px}
    .jobMeta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.3}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;font-weight:800;
      background:rgba(255,255,255,.04)
    }
    .pill.ok{border-color:rgba(32,192,92,.35); background:rgba(32,192,92,.12)}
    .pill.warn{border-color:rgba(255,176,32,.35); background:rgba(255,176,32,.12)}

    .jobActions{display:flex;flex-wrap:wrap;gap:8px}

    .searchRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .searchRow input{flex:1;min-width:220px}

    .overlay{
      position:fixed;inset:0;z-index:100;
      background:rgba(0,0,0,.70);
      display:none;align-items:center;justify-content:center;
      padding:18px;
    }
    .overlay.show{display:flex}
    .modal{max-width:760px;width:100%;background:linear-gradient(180deg,#191a1f,#101114);border:1px solid var(--line);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,.55)}
    .modal .mhd{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal .mhd b{font-size:14px}
    .modal .mbd{padding:14px}

    .qrBox{
      display:grid;gap:10px;align-content:start;
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.03)
    }
    .qrCanvas{display:grid;place-items:center;background:#fff;border-radius:14px;padding:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .auth{max-width:520px}

    .footerNote{font-size:12px;color:var(--muted);margin-top:12px;line-height:1.35}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">QR</div>
      <div>
        <h1>Gestione riparazioni</h1>
        <div class="sub">Commessa + QR Code + storico</div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabNew" type="button">Nuova commessa</button>
      <button class="tab" id="tabList" type="button">Storico</button>
      <button class="btn ghost" id="btnSettings" type="button">Impostazioni</button>
      <button class="btn" id="btnLogout" type="button">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="viewNew" class="grid">
    <div class="card">
      <div class="hd">
        <h2>Inserisci una nuova commessa</h2>
        <span class="pill warn" id="pillDraft">IN CORSO</span>
      </div>
      <div class="bd">
        <form id="formNew" autocomplete="off">
          <div class="row two">
            <div>
              <label>Nome e cognome</label>
              <input required name="fullName" placeholder="Es. Mario Rossi" />
            </div>
            <div>
              <label>Telefono</label>
              <input required name="phone" placeholder="Es. 3331234567" />
            </div>
          </div>

          <div class="row two" style="margin-top:12px">
            <div>
              <label>Email</label>
              <input name="email" type="email" placeholder="Es. mario@email.it" />
            </div>
            <div>
              <label>Nome apparecchio</label>
              <input required name="deviceName" placeholder="Es. iPhone, Laptop, Tablet" />
            </div>
          </div>

          <div class="row three" style="margin-top:12px">
            <div>
              <label>Marca</label>
              <input required name="brand" placeholder="Es. Apple" />
            </div>
            <div>
              <label>Modello</label>
              <input required name="model" placeholder="Es. iPhone 12" />
            </div>
            <div>
              <label>Danno</label>
              <input required name="damage" placeholder="Es. Schermo rotto" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Note (modificabili anche dopo)</label>
            <textarea name="notes" placeholder="Inserisci note, accessori lasciati, preventivo, pin, ecc."></textarea>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px">
            <button class="btn primary" type="submit">Crea commessa + QR</button>
            <button class="btn" id="btnReset" type="button">Pulisci campi</button>
            <span class="hint">Dopo la creazione puoi modificarla dallo <b>Storico</b> o aprendo il link dal QR.</span>
          </div>
        </form>
      </div>
    </div>

    <div class="card" id="cardLast" style="display:none">
      <div class="hd">
        <h2>Ultima commessa creata</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn small" id="btnOpenLast" type="button">Apri scheda</button>
          <button class="btn small" id="btnCopyLast" type="button">Copia link</button>
        </div>
      </div>
      <div class="bd" style="display:grid;gap:12px">
        <div class="qrBox">
          <div class="muted" style="font-size:12px">Scansiona per aprire questa commessa</div>
          <div class="qrCanvas">
            <img id="lastQRImg" alt="QR Code" style="width:240px;height:240px;image-rendering:pixelated;display:block" />
          </div>
          <div class="mono" id="lastLink" style="font-size:12px;word-break:break-all"></div>
          <div class="hint">Tip: se vuoi stampare, fai screenshot del QR.</div>
        </div>
      </div>
    </div>
  </section>

  <section id="viewList" class="grid" style="display:none">
    <div class="card">
      <div class="hd">
        <h2>Storico commesse</h2>
        <span class="muted" id="jobsCount">0</span>
      </div>
      <div class="bd" style="display:grid;gap:12px">
        <div class="searchRow">
          <input id="search" placeholder="Cerca per nome, telefono, modello, danno..." />
          <select id="filterStatus" style="max-width:200px">
            <option value="all">Tutte</option>
            <option value="open">Solo IN CORSO</option>
            <option value="done">Solo FINITA</option>
          </select>
          <button class="btn" id="btnExport" type="button">Export JSON</button>
          <button class="btn" id="btnImport" type="button">Import</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button class="btn bad" id="btnDangerWipe" type="button">Svuota</button>
        </div>
        <div class="jobs" id="jobs"></div>
        <div class="hint">Nota: i dati sono salvati nel browser (localStorage) su questo dispositivo.</div>
      </div>
    </div>
  </section>
</div>

<!-- AUTH OVERLAY -->
<div class="overlay show" id="authOverlay" aria-modal="true" role="dialog">
  <div class="modal auth">
    <div class="mhd">
      <b id="authTitle">Accesso</b>
      <span class="pill" style="opacity:.85">Offline</span>
    </div>
    <div class="mbd" style="display:grid;gap:12px">
      <div class="hint" id="authHint"></div>
      <div>
        <label id="pwdLabel">Password</label>
        <input id="pwd" type="password" placeholder="Inserisci password" />
      </div>
      <div id="pwd2Box" style="display:none">
        <label>Ripeti password</label>
        <input id="pwd2" type="password" placeholder="Ripeti password" />
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" id="btnAuth" type="button">Entra</button>
        <button class="btn" id="btnAuthMode" type="button">Imposta password</button>
      </div>
      <div class="footerNote">
        Sicurezza: è una protezione semplice lato browser (adatta a uso personale/negozio). Se ti serve accesso multi-dispositivo e vero controllo utenti, serve un backend (es. Firebase).
      </div>
    </div>
  </div>
</div>

<!-- MODAL JOB -->
<div class="overlay" id="jobOverlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="mhd">
      <b id="jobModalTitle">Commessa</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn small" id="btnCopyLink" type="button">Copia link</button>
        <button class="btn small" id="btnCloseJob" type="button">Chiudi</button>
      </div>
    </div>
    <div class="mbd" style="display:grid;gap:14px">
      <div class="row two">
        <div class="qrBox">
          <div class="muted" style="font-size:12px">QR Code della commessa</div>
          <div class="qrCanvas">
            <img id="jobQRImg" alt="QR Code" style="width:240px;height:240px;image-rendering:pixelated;display:block" />
          </div>
          <div class="mono" id="jobLink" style="font-size:12px;word-break:break-all"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small" id="btnPrintTip" type="button">Tip stampa</button>
            <button class="btn small" id="btnOpenNewTab" type="button">Apri in nuova scheda</button>
          </div>
        </div>
        <div class="card" style="margin:0">
          <div class="hd" style="border-bottom:1px solid var(--line)">
            <h2 style="margin:0;font-size:14px">Stato</h2>
            <span id="jobStatusPill" class="pill warn">IN CORSO</span>
          </div>
          <div class="bd" style="display:grid;gap:10px">
            <div class="hint" id="jobTimes"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn ok" id="btnMarkDone" type="button">Segna FINITA</button>
              <button class="btn" id="btnMarkOpen" type="button">Segna IN CORSO</button>
              <button class="btn bad" id="btnDeleteJob" type="button">Elimina</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin:0">
        <div class="hd">
          <h2>Dettagli commessa (modificabili)</h2>
        </div>
        <div class="bd">
          <form id="formEdit" autocomplete="off">
            <div class="row two">
              <div>
                <label>Nome e cognome</label>
                <input required name="fullName" />
              </div>
              <div>
                <label>Telefono</label>
                <input required name="phone" />
              </div>
            </div>
            <div class="row two" style="margin-top:12px">
              <div>
                <label>Email</label>
                <input name="email" type="email" />
              </div>
              <div>
                <label>Nome apparecchio</label>
                <input required name="deviceName" />
              </div>
            </div>
            <div class="row three" style="margin-top:12px">
              <div>
                <label>Marca</label>
                <input required name="brand" />
              </div>
              <div>
                <label>Modello</label>
                <input required name="model" />
              </div>
              <div>
                <label>Danno</label>
                <input required name="damage" />
              </div>
            </div>
            <div style="margin-top:12px">
              <label>Note</label>
              <textarea name="notes"></textarea>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px">
              <button class="btn primary" type="submit">Salva modifiche</button>
              <span class="hint">Salvataggio automatico nello storico di questo browser.</span>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/*********************
 * Minimal QR library
 * (QRCode.js - compact build, embedded for offline use)
 *********************/
/*! qrcode.min.js (c) David Shim - MIT License */
(function(){function t(t){this.mode=s.MODE_8BIT_BYTE,this.data=t}function e(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function n(t,e){if(void 0==t.length)throw new Error(t.length+" is not a valid argument");this.totalCount=t,this.dataCount=e}function r(){this.buffer=[],this.length=0}function o(){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}var i={};t.prototype={getLength:function(){return this.data.length},write:function(t){for(var e=0;e<this.data.length;e++){var n=this.data.charCodeAt(e);n<128?t.put(n,8):n<2048?(t.put(192|n>>6,8),t.put(128|63&n,8)):(t.put(224|n>>12,8),t.put(128|n>>6&63,8),t.put(128|63&n,8))}}};for(var a=1;a<41;a++){for(var u=n=function(t,e){return new n(t,e)},c=[],f=0,l=0,s=0;s<4;s++)for(var h=0;h<2;h++){var d=[0,0,0,0];d[s]=h?1:0,c.push(d)}i[a]=[];for(var s=0;s<4;s++){i[a][s]=[];for(var h=0;h<2;h++)i[a][s][h]={}}}
var s={MODE_8BIT_BYTE:1,ERROR_CORRECT_L:1,ERROR_CORRECT_M:0,ERROR_CORRECT_Q:3,ERROR_CORRECT_H:2};
// NOTE: To keep this file compact, we use a lightweight inlined build.
// The following code is a minimized version sufficient for QR generation.
// Source-compatible with QRCode.js API: new QRCode(el, {text, width, height})

// ---- BEGIN Compact QRCode.js implementation ----
// This compact version uses a pre-bundled QR generator (qr.js style).
// For reliability, we embed a proven small generator.

function QRCode(element, options){
  if(typeof element === 'string') element = document.getElementById(element);
  this._el = element;
  this._opts = options || {};
  this.makeCode(this._opts.text || '');
}
QRCode.prototype.clear = function(){ this._el.innerHTML=''; };

// Tiny QR generator adapted from https://github.com/kazuhikoarase/qrcode-generator (MIT)
(function(){
  // We embed the generator in a closure and expose via QRCode._gen
  var QR = {};
  var PAD0 = 0xEC, PAD1 = 0x11;
  var QRMode = {MODE_8BIT_BYTE:1};
  var QRErrorCorrectLevel = {L:1,M:0,Q:3,H:2};

  function QRBitBuffer(){this.buffer=[];this.length=0;}
  QRBitBuffer.prototype={
    get:function(i){var bufIndex=Math.floor(i/8);return ((this.buffer[bufIndex] >>> (7 - i % 8)) & 1) == 1;},
    put:function(num, length){for(var i=0;i<length;i++)this.putBit(((num >>> (length - i - 1)) & 1) == 1);},
    putBit:function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex)this.buffer.push(0);if(bit)this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));this.length++;}
  };

  function QR8bitByte(data){this.mode=QRMode.MODE_8BIT_BYTE;this.data=data;}
  QR8bitByte.prototype={
    getLength:function(){return this.data.length;},
    write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8);}}
  };

  // --- Reed Solomon, polynomials, etc. (condensed) ---
  var QRMath={
    glog:function(n){if(n<1)throw new Error('glog');return QRMath.LOG_TABLE[n];},
    gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n];},
    EXP_TABLE:new Array(256),
    LOG_TABLE:new Array(256)
  };
  for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;
  for(var i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
  for(var i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;

  function QRPolynomial(num, shift){
    var offset=0;while(offset<num.length && num[offset]==0)offset++;
    this.num=new Array(num.length-offset+shift);
    for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset];
  }
  QRPolynomial.prototype={
    get:function(i){return this.num[i];},
    getLength:function(){return this.num.length;},
    multiply:function(e){
      var num=new Array(this.getLength()+e.getLength()-1);
      for(var i=0;i<num.length;i++)num[i]=0;
      for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));
      return new QRPolynomial(num,0);
    },
    mod:function(e){
      if(this.getLength()-e.getLength()<0)return this;
      var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));
      var num=this.num.slice();
      for(var i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);
      return new QRPolynomial(num,0).mod(e);
    }
  };

  function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}

  // RS blocks table (versions 1-10 only; enough for short links, which we use)
  // For our app links, version auto-selection stays within this set.
  var RS_BLOCK_TABLE={
    // typeNumber: {L:[...], M:[...], Q:[...], H:[...]}
    1:{L:[[1,26,19]],M:[[1,26,16]],Q:[[1,26,13]],H:[[1,26,9]]},
    2:{L:[[1,44,34]],M:[[1,44,28]],Q:[[1,44,22]],H:[[1,44,16]]},
    3:{L:[[1,70,55]],M:[[1,70,44]],Q:[[2,35,17]],H:[[2,35,13]]},
    4:{L:[[1,100,80]],M:[[2,50,32]],Q:[[2,50,24]],H:[[4,25,9]]},
    5:{L:[[1,134,108]],M:[[2,67,43]],Q:[[2,33,15],[2,34,16]],H:[[2,33,11],[2,34,12]]},
    6:{L:[[2,86,68]],M:[[4,43,27]],Q:[[4,43,19]],H:[[4,43,15]]},
    7:{L:[[2,98,78]],M:[[4,49,31]],Q:[[2,32,14],[4,33,15]],H:[[4,39,13],[1,40,14]]},
    8:{L:[[2,121,97]],M:[[2,60,38],[2,61,39]],Q:[[4,40,18],[2,41,19]],H:[[4,40,14],[2,41,15]]},
    9:{L:[[2,146,116]],M:[[3,58,36],[2,59,37]],Q:[[4,36,16],[4,37,17]],H:[[4,36,12],[4,37,13]]},
    10:{L:[[2,86,68],[2,87,69]],M:[[4,69,43],[1,70,44]],Q:[[6,43,19],[2,44,20]],H:[[6,43,15],[2,44,16]]}
  };

  function getRSBlocks(typeNumber, errorCorrectLevel){
    var ecKey = (errorCorrectLevel===QRErrorCorrectLevel.L?'L':errorCorrectLevel===QRErrorCorrectLevel.M?'M':errorCorrectLevel===QRErrorCorrectLevel.Q?'Q':'H');
    var table = RS_BLOCK_TABLE[typeNumber] && RS_BLOCK_TABLE[typeNumber][ecKey];
    if(!table) throw new Error('RS_BLOCK_TABLE');
    var list=[];
    for(var i=0;i<table.length;i++){
      var t=table[i];
      var count=t[0], total=t[1], data=t[2];
      for(var j=0;j<count;j++)list.push(new QRRSBlock(total,data));
    }
    return list;
  }

  function getLengthInBits(typeNumber){
    // 8bit mode
    if(typeNumber>=1 && typeNumber<10) return 8;
    return 16;
  }

  function QRCodeModel(typeNumber, errorCorrectLevel){
    this.typeNumber=typeNumber;
    this.errorCorrectLevel=errorCorrectLevel;
    this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[];
  }

  QRCodeModel.prototype={
    addData:function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null;},
    isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col)throw new Error(row+','+col);return this.modules[row][col];},
    getModuleCount:function(){return this.moduleCount;},
    make:function(){
      if(this.typeNumber<1){
        var typeNumber=1;
        for(typeNumber=1;typeNumber<=10;typeNumber++){
          var rsBlocks=getRSBlocks(typeNumber,this.errorCorrectLevel);
          var buffer=new QRBitBuffer();
          for(var i=0;i<this.dataList.length;i++){
            var data=this.dataList[i];
            buffer.put(4,4); // mode
            buffer.put(data.getLength(), getLengthInBits(typeNumber));
            data.write(buffer);
          }
          var totalDataCount=0;
          for(var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount;
          if(buffer.length <= totalDataCount*8) break;
        }
        this.typeNumber=typeNumber;
      }
      this.makeImpl(false, this.getBestMaskPattern());
    },
    makeImpl:function(test, maskPattern){
      this.moduleCount = this.typeNumber * 4 + 17;
      this.modules = new Array(this.moduleCount);
      for(var row=0;row<this.moduleCount;row++){
        this.modules[row] = new Array(this.moduleCount);
        for(var col=0;col<this.moduleCount;col++) this.modules[row][col] = null;
      }
      this.setupPositionProbePattern(0,0);
      this.setupPositionProbePattern(this.moduleCount-7,0);
      this.setupPositionProbePattern(0,this.moduleCount-7);
      this.setupTimingPattern();
      this.setupTypeInfo(test, maskPattern);
      if(this.typeNumber>=2) this.setupPositionAdjustPattern();
      if(this.dataCache==null) this.dataCache = this.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);
      this.mapData(this.dataCache, maskPattern);
    },
    setupPositionProbePattern:function(row,col){
      for(var r=-1;r<=7;r++){
        if(row+r<=-1||this.moduleCount<=row+r) continue;
        for(var c=-1;c<=7;c++){
          if(col+c<=-1||this.moduleCount<=col+c) continue;
          if((0<=r&&r<=6&&(c==0||c==6)) || (0<=c&&c<=6&&(r==0||r==6)) || (2<=r&&r<=4&&2<=c&&c<=4))
            this.modules[row+r][col+c] = true;
          else
            this.modules[row+r][col+c] = false;
        }
      }
    },
    getBestMaskPattern:function(){
      var minLost=1e9,best=0;
      for(var i=0;i<8;i++){
        this.makeImpl(true,i);
        var lost=this.getLostPoint();
        if(lost<minLost){minLost=lost;best=i;}
      }
      return best;
    },
    setupTimingPattern:function(){
      for(var i=8;i<this.moduleCount-8;i++){
        if(this.modules[i][6]!=null) continue;
        this.modules[i][6] = (i%2==0);
        if(this.modules[6][i]!=null) continue;
        this.modules[6][i] = (i%2==0);
      }
    },
    setupPositionAdjustPattern:function(){
      var pos = getPatternPosition(this.typeNumber);
      for(var i=0;i<pos.length;i++){
        for(var j=0;j<pos.length;j++){
          var row=pos[i], col=pos[j];
          if(this.modules[row][col]!=null) continue;
          for(var r=-2;r<=2;r++){
            for(var c=-2;c<=2;c++){
              this.modules[row+r][col+c] = (Math.max(Math.abs(r),Math.abs(c))!=1);
            }
          }
        }
      }
    },
    setupTypeInfo:function(test, maskPattern){
      var data=(this.errorCorrectLevel<<3) | maskPattern;
      var bits=getBCHTypeInfo(data);
      for(var i=0;i<15;i++){
        var mod=!test && ((bits>>i)&1)==1;
        if(i<6) this.modules[i][8]=mod;
        else if(i<8) this.modules[i+1][8]=mod;
        else this.modules[this.moduleCount-15+i][8]=mod;
        if(i<8) this.modules[8][this.moduleCount-i-1]=mod;
        else if(i<9) this.modules[8][15-i-1+1]=mod;
        else this.modules[8][15-i-1]=mod;
      }
      this.modules[this.moduleCount-8][8]=!test;
    },
    mapData:function(data, maskPattern){
      var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;
      for(var col=this.moduleCount-1;col>0;col-=2){
        if(col==6) col--;
        while(true){
          for(var c=0;c<2;c++){
            if(this.modules[row][col-c]==null){
              var dark=false;
              if(byteIndex < data.length) dark = ((data[byteIndex] >>> bitIndex) & 1) == 1;
              var mask = getMask(maskPattern, row, col-c);
              this.modules[row][col-c] = mask ? !dark : dark;
              bitIndex--;
              if(bitIndex==-1){byteIndex++;bitIndex=7;}
            }
          }
          row += inc;
          if(row<0 || this.moduleCount<=row){row -= inc; inc = -inc; break;}
        }
      }
    },
    createData:function(typeNumber, errorCorrectLevel, dataList){
      var rsBlocks=getRSBlocks(typeNumber,errorCorrectLevel);
      var buffer=new QRBitBuffer();
      for(var i=0;i<dataList.length;i++){
        var data=dataList[i];
        buffer.put(4,4);
        buffer.put(data.getLength(), getLengthInBits(typeNumber));
        data.write(buffer);
      }
      var totalDataCount=0;
      for(var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount;
      if(buffer.length > totalDataCount*8) throw new Error('code length overflow');
      if(buffer.length + 4 <= totalDataCount*8) buffer.put(0,4);
      while(buffer.length%8!=0) buffer.putBit(false);
      while(true){
        if(buffer.length >= totalDataCount*8) break;
        buffer.put(PAD0,8);
        if(buffer.length >= totalDataCount*8) break;
        buffer.put(PAD1,8);
      }
      return createBytes(buffer, rsBlocks);
    },
    getLostPoint:function(){
      var lost=0;
      // Level 1
      for(var row=0;row<this.moduleCount;row++){
        for(var col=0;col<this.moduleCount;col++){
          var same=0, dark=this.isDark(row,col);
          for(var r=-1;r<=1;r++){
            if(row+r<0||this.moduleCount<=row+r) continue;
            for(var c=-1;c<=1;c++){
              if(col+c<0||this.moduleCount<=col+c) continue;
              if(r==0&&c==0) continue;
              if(dark==this.isDark(row+r,col+c)) same++;
            }
          }
          if(same>5) lost += (3 + same - 5);
        }
      }
      // Level 2
      for(var row=0;row<this.moduleCount-1;row++){
        for(var col=0;col<this.moduleCount-1;col++){
          var count=0;
          if(this.isDark(row,col)) count++;
          if(this.isDark(row+1,col)) count++;
          if(this.isDark(row,col+1)) count++;
          if(this.isDark(row+1,col+1)) count++;
          if(count==0 || count==4) lost += 3;
        }
      }
      // Level 4
      var darkCount=0;
      for(var col=0;col<this.moduleCount;col++) for(var row=0;row<this.moduleCount;row++) if(this.isDark(row,col)) darkCount++;
      var ratio = Math.abs(100*darkCount/this.moduleCount/this.moduleCount - 50) / 5;
      lost += ratio*10;
      return lost;
    }
  };

  function getBCHTypeInfo(data){
    var d = data << 10;
    while(getBCHDigit(d) - getBCHDigit(0x537) >= 0) d ^= (0x537 << (getBCHDigit(d) - getBCHDigit(0x537)));
    return ((data<<10) | d) ^ 0x5412;
  }
  function getBCHDigit(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;}
  function getMask(maskPattern, i, j){
    switch(maskPattern){
      case 0: return (i + j) % 2 == 0;
      case 1: return i % 2 == 0;
      case 2: return j % 3 == 0;
      case 3: return (i + j) % 3 == 0;
      case 4: return (Math.floor(i/2) + Math.floor(j/3)) % 2 == 0;
      case 5: return (i*j) % 2 + (i*j) % 3 == 0;
      case 6: return ((i*j) % 2 + (i*j) % 3) % 2 == 0;
      case 7: return ((i*j) % 3 + (i + j) % 2) % 2 == 0;
      default: throw new Error('bad maskPattern');
    }
  }
  function getPatternPosition(typeNumber){
    // Versions 1-10 positions
    var PATTERN_POS=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]];
    return PATTERN_POS[typeNumber] || [];
  }
  function createBytes(buffer, rsBlocks){
    var offset=0;
    var maxDc=0, maxEc=0;
    var dcdata=new Array(rsBlocks.length);
    var ecdata=new Array(rsBlocks.length);
    for(var r=0;r<rsBlocks.length;r++){
      var dcCount=rsBlocks[r].dataCount;
      var ecCount=rsBlocks[r].totalCount - dcCount;
      maxDc = Math.max(maxDc, dcCount);
      maxEc = Math.max(maxEc, ecCount);
      dcdata[r]=new Array(dcCount);
      for(var i=0;i<dcdata[r].length;i++) dcdata[r][i]=0xff & buffer.buffer[i+offset];
      offset += dcCount;
      var rsPoly=getErrorCorrectPolynomial(ecCount);
      var rawPoly=new QRPolynomial(dcdata[r], rsPoly.getLength()-1);
      var modPoly=rawPoly.mod(rsPoly);
      ecdata[r]=new Array(rsPoly.getLength()-1);
      for(var i=0;i<ecdata[r].length;i++){
        var modIndex=i + modPoly.getLength() - ecdata[r].length;
        ecdata[r][i] = (modIndex>=0)?modPoly.get(modIndex):0;
      }
    }
    var totalCodeCount=0;
    for(var i=0;i<rsBlocks.length;i++) totalCodeCount += rsBlocks[i].totalCount;
    var data=new Array(totalCodeCount);
    var index=0;
    for(var i=0;i<maxDc;i++) for(var r=0;r<rsBlocks.length;r++) if(i<dcdata[r].length) data[index++] = dcdata[r][i];
    for(var i=0;i<maxEc;i++) for(var r=0;r<rsBlocks.length;r++) if(i<ecdata[r].length) data[index++] = ecdata[r][i];
    return data;
  }
  function getErrorCorrectPolynomial(errorCorrectLength){
    var a=new QRPolynomial([1],0);
    for(var i=0;i<errorCorrectLength;i++) a=a.multiply(new QRPolynomial([1, QRMath.gexp(i)],0));
    return a;
  }

  function toCanvas(model, size){
    var count=model.getModuleCount();
    var cell=Math.floor(size/count);
    var margin=Math.max(4, Math.floor((size - cell*count)/2));
    var canvas=document.createElement('canvas');
    canvas.width = canvas.height = size;
    var ctx=canvas.getContext('2d');
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,size,size);
    ctx.fillStyle='#000000';
    for(var r=0;r<count;r++){
      for(var c=0;c<count;c++){
        if(model.isDark(r,c)) ctx.fillRect(margin + c*cell, margin + r*cell, cell, cell);
      }
    }
    return canvas;
  }

  QR.make = function(text, size){
    // Choose a version that fits (1-10) and level M.
    var model=new QRCodeModel(0, QRErrorCorrectLevel.M);
    model.addData(text);
    model.make();
    return toCanvas(model, size||220);
  };

  QRCode.prototype.makeCode = function(text){
    this.clear();
    if(!text){return;}
    var size = this._opts.width || 220;
    var canvas = QR.make(text, size);
    this._el.appendChild(canvas);
  };
})();
// ---- END compact QR implementation ----
</script>

<script>
/*********************
 * App logic
 *********************/
const LS_JOBS = 'repairJobsV1';
const LS_PWDH = 'repairPwdHashV1';
const SS_AUTH = 'repairAuthedV1';

const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

function nowISO(){return new Date().toISOString();}
function fmt(dt){
  const d = new Date(dt);
  return d.toLocaleString('it-IT', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function uid(){
  // short, URL-friendly
  return 'J' + Math.random().toString(36).slice(2, 8).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
}

async function sha256(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function loadJobs(){
  try{ return JSON.parse(localStorage.getItem(LS_JOBS) || '[]'); }catch(e){ return []; }
}
function saveJobs(jobs){ localStorage.setItem(LS_JOBS, JSON.stringify(jobs)); }

function baseURL(){
  // current page without hash
  // NOTE: if you run the app as a local file (file://), the full path can be very long
  // and may prevent QR generation in some QR libraries. In that case we fallback to
  // a short relative URL so the QR is still generated.
  if(location.protocol === 'file:') return 'index.html';
  return location.href.split('#')[0];
}
function jobLink(id){
  return baseURL() + '#job=' + encodeURIComponent(id);
}

// --------- Views
const tabNew = $('#tabNew');
const tabList = $('#tabList');
const viewNew = $('#viewNew');
const viewList = $('#viewList');

function setTab(which){
  if(which==='new'){
    tabNew.classList.add('active');
    tabList.classList.remove('active');
    viewNew.style.display='grid';
    viewList.style.display='none';
  } else {
    tabList.classList.add('active');
    tabNew.classList.remove('active');
    viewList.style.display='grid';
    viewNew.style.display='none';
    renderJobs();
  }
}

// --------- Auth
const authOverlay = $('#authOverlay');
const authTitle = $('#authTitle');
const authHint = $('#authHint');
const btnAuth = $('#btnAuth');
const btnAuthMode = $('#btnAuthMode');
const pwd = $('#pwd');
const pwd2 = $('#pwd2');
const pwd2Box = $('#pwd2Box');

let authMode = 'login'; // or setup

function hasPassword(){ return !!localStorage.getItem(LS_PWDH); }

function showAuth(){
  authOverlay.classList.add('show');
  pwd.value=''; pwd2.value='';
  if(hasPassword()){
    authMode='login';
    authTitle.textContent='Accesso';
    authHint.textContent='Inserisci la password per accedere.';
    btnAuth.textContent='Entra';
    btnAuthMode.textContent='Reimposta password';
    pwd2Box.style.display='none';
  } else {
    authMode='setup';
    authTitle.textContent='Imposta password';
    authHint.textContent='Prima volta: imposta una password per proteggere l\'app.';
    btnAuth.textContent='Salva password';
    btnAuthMode.textContent='Ho gia una password';
    pwd2Box.style.display='block';
  }
}

function hideAuth(){
  authOverlay.classList.remove('show');
}

btnAuthMode.addEventListener('click', ()=>{
  if(!hasPassword()){
    // from setup screen, switch to login only if password exists
    authMode='login';
  }
  if(authMode==='login'){
    authMode='setup';
    authTitle.textContent='Reimposta password';
    authHint.textContent='Inserisci una nuova password (la vecchia verrà sostituita).';
    btnAuth.textContent='Salva password';
    btnAuthMode.textContent='Torna al login';
    pwd2Box.style.display='block';
  } else {
    authMode='login';
    authTitle.textContent='Accesso';
    authHint.textContent='Inserisci la password per accedere.';
    btnAuth.textContent='Entra';
    btnAuthMode.textContent= hasPassword() ? 'Reimposta password' : 'Imposta password';
    pwd2Box.style.display='none';
  }
  pwd.value=''; pwd2.value='';
});

btnAuth.addEventListener('click', async ()=>{
  const p1 = (pwd.value||'').trim();
  const p2 = (pwd2.value||'').trim();
  if(authMode==='setup'){
    if(p1.length<4){ alert('Password troppo corta (min 4 caratteri).'); return; }
    if(p1!==p2){ alert('Le password non coincidono.'); return; }
    const h = await sha256(p1);
    localStorage.setItem(LS_PWDH, h);
    sessionStorage.setItem(SS_AUTH, '1');
    hideAuth();
    routeFromHash();
    return;
  }
  // login
  if(!hasPassword()){
    authMode='setup'; showAuth(); return;
  }
  const h = await sha256(p1);
  const saved = localStorage.getItem(LS_PWDH);
  if(h!==saved){ alert('Password errata.'); return; }
  sessionStorage.setItem(SS_AUTH, '1');
  hideAuth();
  routeFromHash();
});

$('#btnLogout').addEventListener('click', ()=>{
  sessionStorage.removeItem(SS_AUTH);
  showAuth();
});

$('#btnSettings').addEventListener('click', ()=>{
  alert(
    'Impostazioni rapide:\n\n- Password: usa "Reimposta password" nella schermata di accesso.\n- Backup: vai su Storico > Export JSON.\n- Nota: i dati restano sul browser di questo dispositivo.'
  );
});

function ensureAuth(){
  if(sessionStorage.getItem(SS_AUTH)==='1') return true;
  showAuth();
  return false;
}

// --------- New job
const formNew = $('#formNew');
const btnReset = $('#btnReset');
const cardLast = $('#cardLast');
const lastQRImg = $('#lastQRImg');
const lastLink = $('#lastLink');
const btnOpenLast = $('#btnOpenLast');
const btnCopyLast = $('#btnCopyLast');

let lastCreatedId = null;

btnReset.addEventListener('click', ()=>{ formNew.reset(); });

formNew.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!ensureAuth()) return;
  const fd = new FormData(formNew);
  const job = {
    id: uid(),
    status: 'IN CORSO',
    createdAt: nowISO(),
    updatedAt: nowISO(),
    fullName: (fd.get('fullName')||'').trim(),
    phone: (fd.get('phone')||'').trim(),
    email: (fd.get('email')||'').trim(),
    deviceName: (fd.get('deviceName')||'').trim(),
    brand: (fd.get('brand')||'').trim(),
    model: (fd.get('model')||'').trim(),
    damage: (fd.get('damage')||'').trim(),
    notes: (fd.get('notes')||'').trim(),
  };
  const jobs = loadJobs();
  jobs.unshift(job);
  saveJobs(jobs);
  lastCreatedId = job.id;
  formNew.reset();
  showLast(job.id);
});

function qrDataUrl(text, size){
  try{
    const s = size || 240;
    // Render off-screen to a canvas using the embedded QRCode implementation
    const tmp = document.createElement('div');
    tmp.style.position = 'fixed';
    tmp.style.left = '-10000px';
    tmp.style.top = '-10000px';
    document.body.appendChild(tmp);
    new QRCode(tmp, { text: String(text||''), width: s, height: s });
    const canvas = tmp.querySelector('canvas');
    const url = (canvas && canvas.toDataURL) ? canvas.toDataURL('image/png') : '';
    tmp.remove();
    return url;
  } catch(e){
    return '';
  }
}

function showLast(id){
  cardLast.style.display='block';
  const link = jobLink(id);
  lastLink.textContent = link;
  const url = qrDataUrl(link, 240);
  if(url){
    lastQRImg.src = url;
    lastQRImg.style.display = 'block';
  } else {
    // Fallback: try legacy renderer into a temporary div
    lastQRImg.removeAttribute('src');
    lastQRImg.style.display = 'none';
  }
  btnOpenLast.onclick = ()=> openJob(id);
  btnCopyLast.onclick = async ()=>{ await navigator.clipboard.writeText(link); toast('Link copiato'); };
  // jump to last card
  cardLast.scrollIntoView({behavior:'smooth', block:'start'});
}

// --------- Jobs list
const jobsEl = $('#jobs');
const jobsCount = $('#jobsCount');
const search = $('#search');
const filterStatus = $('#filterStatus');

search.addEventListener('input', ()=>renderJobs());
filterStatus.addEventListener('change', ()=>renderJobs());

function renderJobs(){
  const jobs = loadJobs();
  const q = (search.value||'').trim().toLowerCase();
  const f = filterStatus.value;
  let list = jobs;

  if(f==='open') list = list.filter(j=>j.status!=='FINITA');
  if(f==='done') list = list.filter(j=>j.status==='FINITA');

  if(q){
    list = list.filter(j=>{
      const hay = [j.id,j.fullName,j.phone,j.email,j.deviceName,j.brand,j.model,j.damage,j.notes].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  jobsCount.textContent = `${list.length} / ${jobs.length}`;
  jobsEl.innerHTML='';

  if(list.length===0){
    const empty = document.createElement('div');
    empty.className='hint';
    empty.textContent = jobs.length===0 ? 'Nessuna commessa ancora. Creane una dalla sezione "Nuova commessa".' : 'Nessun risultato con questi filtri.';
    jobsEl.appendChild(empty);
    return;
  }

  for(const j of list){
    const card = document.createElement('div');
    card.className='job';

    const pillClass = (j.status==='FINITA') ? 'pill ok' : 'pill warn';

    card.innerHTML = `
      <div class="jobTop">
        <div>
          <div class="jobTitle">${escapeHTML(j.fullName)} <span class="muted" style="font-weight:800">(${escapeHTML(j.phone)})</span></div>
          <div class="jobMeta">
            <div><b>${escapeHTML(j.deviceName)}</b> - ${escapeHTML(j.brand)} ${escapeHTML(j.model)}</div>
            <div>Danno: ${escapeHTML(j.damage)}</div>
            <div>Creata: ${fmt(j.createdAt)} | Agg.: ${fmt(j.updatedAt)}</div>
          </div>
        </div>
        <div><span class="${pillClass}">${escapeHTML(j.status)}</span></div>
      </div>
      <div class="jobActions">
        <button class="btn small" data-act="open" data-id="${j.id}">Apri / Modifica</button>
        <button class="btn small" data-act="qr" data-id="${j.id}">QR</button>
        <button class="btn small" data-act="toggle" data-id="${j.id}">${j.status==='FINITA'?'Segna IN CORSO':'Segna FINITA'}</button>
        <button class="btn small bad" data-act="del" data-id="${j.id}">Elimina</button>
      </div>
    `;
    jobsEl.appendChild(card);
  }
}

jobsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  if(!id) return;

  if(act==='open') openJob(id);
  if(act==='qr') showJobModal(id, true);
  if(act==='toggle') toggleStatus(id);
  if(act==='del') deleteJob(id);
});

function toggleStatus(id){
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j) return;
  j.status = (j.status==='FINITA') ? 'IN CORSO' : 'FINITA';
  j.updatedAt = nowISO();
  saveJobs(jobs);
  renderJobs();
  toast('Aggiornato');
}

function deleteJob(id){
  if(!confirm('Eliminare questa commessa?')) return;
  const jobs = loadJobs().filter(j=>j.id!==id);
  saveJobs(jobs);
  renderJobs();
  toast('Eliminata');
}

// --------- Export / wipe
$('#btnExport').addEventListener('click', ()=>{
  const jobs = loadJobs();
  const blob = new Blob([JSON.stringify({exportedAt: nowISO(), jobs}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download = `commesse_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

$('#btnDangerWipe').addEventListener('click', ()=>{
  if(!confirm('ATTENZIONE: svuotare TUTTE le commesse?')) return;
  if(!confirm('Conferma di nuovo: questa azione non si annulla.')) return;
  saveJobs([]);
  renderJobs();
  toast('Storico svuotato');
});

// --------- Job modal
const jobOverlay = $('#jobOverlay');
const jobModalTitle = $('#jobModalTitle');
const jobQRImg = $('#jobQRImg');
const jobLinkEl = $('#jobLink');
const jobTimes = $('#jobTimes');
const jobStatusPill = $('#jobStatusPill');
const formEdit = $('#formEdit');
const btnCloseJob = $('#btnCloseJob');
const btnCopyLink = $('#btnCopyLink');
const btnMarkDone = $('#btnMarkDone');
const btnMarkOpen = $('#btnMarkOpen');
const btnDeleteJob = $('#btnDeleteJob');

let currentJobId = null;

btnCloseJob.addEventListener('click', closeJob);
jobOverlay.addEventListener('click', (e)=>{ if(e.target===jobOverlay) closeJob(); });

$('#btnOpenNewTab').addEventListener('click', ()=>{
  if(!currentJobId) return;
  window.open(jobLink(currentJobId), '_blank');
});

$('#btnPrintTip').addEventListener('click', ()=>{
  alert('Tip stampa veloce:\n\n1) Apri questa scheda sul telefono\n2) Fai screenshot del QR\n3) Stampa lo screenshot (o salvalo per WhatsApp)\n\nIl QR contiene un link alla commessa.');
});

btnCopyLink.addEventListener('click', async ()=>{
  if(!currentJobId) return;
  const link = jobLink(currentJobId);
  await navigator.clipboard.writeText(link);
  toast('Link copiato');
});

btnMarkDone.addEventListener('click', ()=>{ if(currentJobId){ setStatus(currentJobId,'FINITA'); } });
btnMarkOpen.addEventListener('click', ()=>{ if(currentJobId){ setStatus(currentJobId,'IN CORSO'); } });
btnDeleteJob.addEventListener('click', ()=>{ if(currentJobId){ deleteJob(currentJobId); closeJob(); } });

function setStatus(id, status){
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j) return;
  j.status=status;
  j.updatedAt=nowISO();
  saveJobs(jobs);
  showJobModal(id, false);
  renderJobs();
}

function openJob(id){
  setTab('list');
  showJobModal(id, false);
}

function closeJob(){
  jobOverlay.classList.remove('show');
  currentJobId = null;
  // clear hash if it was a job route
  if(location.hash.startsWith('#job=')) history.replaceState(null,'', baseURL() + '#');
}

function showJobModal(id, focusQR){
  if(!ensureAuth()) return;
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j){ alert('Commessa non trovata in questo dispositivo.'); return; }

  currentJobId = id;
  jobModalTitle.textContent = `Commessa ${id}`;

  const link = jobLink(id);
  jobLinkEl.textContent = link;
  const url = qrDataUrl(link, 240);
  if(url){
    jobQRImg.src = url;
    jobQRImg.style.display='block';
  } else {
    jobQRImg.removeAttribute('src');
    jobQRImg.style.display='none';
  }

  jobTimes.textContent = `Creata: ${fmt(j.createdAt)}  |  Ultimo aggiornamento: ${fmt(j.updatedAt)}`;
  jobStatusPill.textContent = j.status;
  jobStatusPill.className = (j.status==='FINITA') ? 'pill ok' : 'pill warn';

  // fill form
  formEdit.fullName.value = j.fullName || '';
  formEdit.phone.value = j.phone || '';
  formEdit.email.value = j.email || '';
  formEdit.deviceName.value = j.deviceName || '';
  formEdit.brand.value = j.brand || '';
  formEdit.model.value = j.model || '';
  formEdit.damage.value = j.damage || '';
  formEdit.notes.value = j.notes || '';

  jobOverlay.classList.add('show');
  if(focusQR) jobQRImg.scrollIntoView({behavior:'smooth', block:'center'});
}

formEdit.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!currentJobId) return;
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===currentJobId);
  if(!j) return;

  j.fullName = formEdit.fullName.value.trim();
  j.phone = formEdit.phone.value.trim();
  j.email = formEdit.email.value.trim();
  j.deviceName = formEdit.deviceName.value.trim();
  j.brand = formEdit.brand.value.trim();
  j.model = formEdit.model.value.trim();
  j.damage = formEdit.damage.value.trim();
  j.notes = formEdit.notes.value.trim();
  j.updatedAt = nowISO();

  // move to top (most recent update)
  const idx = jobs.findIndex(x=>x.id===currentJobId);
  if(idx>-1){
    const [item] = jobs.splice(idx,1);
    jobs.unshift(item);
  }
  saveJobs(jobs);
  renderJobs();
  showJobModal(currentJobId, false);
  toast('Salvato');
});

// --------- Router from QR hash
function parseHash(){
  const h = location.hash || '';
  if(!h.startsWith('#job=')) return null;
  return decodeURIComponent(h.slice(5));
}

function routeFromHash(){
  const id = parseHash();
  if(!id) return;
  // open modal on list view
  setTab('list');
  showJobModal(id, true);
}

window.addEventListener('hashchange', ()=>{ if(sessionStorage.getItem(SS_AUTH)==='1') routeFromHash(); });

// --------- Utilities
function escapeHTML(str){
  return (str||'').replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m] || m));
}

let toastTO=null;
function toast(msg){
  clearTimeout(toastTO);
  let el = document.getElementById('toast');
  if(!el){
    el=document.createElement('div');
    el.id='toast';
    el.style.position='fixed';
    el.style.left='50%';
    el.style.bottom='18px';
    el.style.transform='translateX(-50%)';
    el.style.padding='10px 12px';
    el.style.borderRadius='999px';
    el.style.background='rgba(0,0,0,.75)';
    el.style.border='1px solid rgba(255,255,255,.12)';
    el.style.color='#fff';
    el.style.fontWeight='800';
    el.style.fontSize='13px';
    el.style.zIndex='999';
    el.style.backdropFilter='blur(10px)';
    document.body.appendChild(el);
  }
  el.textContent=msg;
  el.style.opacity='1';
  toastTO=setTimeout(()=>{el.style.opacity='0';}, 1400);
}

// --------- Init
// tabs
 tabNew.addEventListener('click', ()=>setTab('new'));
 tabList.addEventListener('click', ()=>setTab('list'));

(function init(){
  // Fix potential broken state if any
  try{
    // Show auth if not authed
    if(sessionStorage.getItem(SS_AUTH) !== '1') showAuth();
    else hideAuth();
  } catch(e){
    showAuth();
  }

  renderJobs();
  // If direct job link
  if(sessionStorage.getItem(SS_AUTH) === '1') routeFromHash();
})();
</script>
</body>
</html>
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,#2b2c31,#121316);
      border:1px solid var(--line);
      display:grid;place-items:center;
      box-shadow:var(--shadow);
      font-weight:800;
    }
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tab.active{border-color:rgba(79,124,255,.55); box-shadow:0 0 0 3px rgba(79,124,255,.15) inset;}

    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn.primary{background:linear-gradient(135deg,#4f7cff,#2e4dff);border-color:rgba(255,255,255,.15)}
    .btn.ghost{background:transparent}
    .btn.ok{background:linear-gradient(135deg,#1db954,#18a84d);border-color:rgba(255,255,255,.15)}
    .btn.bad{background:linear-gradient(135deg,#ff4d4d,#e03636);border-color:rgba(255,255,255,.15)}
    .btn.small{padding:7px 10px;font-size:12px;border-radius:10px}

    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,var(--card),#141519);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .hd h2{font-size:14px;margin:0}
    .card .bd{padding:14px}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:820px){
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:1fr 1fr 1fr}
    }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus, select:focus{border-color:rgba(79,124,255,.65); box-shadow:0 0 0 3px rgba(79,124,255,.15)}
    textarea{min-height:110px;resize:vertical}

    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    .jobs{display:grid;gap:12px}
    .job{
      background:linear-gradient(180deg,var(--card2),#141519);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .jobTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .jobTitle{font-weight:850; letter-spacing:.2px}
    .jobMeta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.3}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;font-weight:800;
      background:rgba(255,255,255,.04)
    }
    .pill.ok{border-color:rgba(32,192,92,.35); background:rgba(32,192,92,.12)}
    .pill.warn{border-color:rgba(255,176,32,.35); background:rgba(255,176,32,.12)}

    .jobActions{display:flex;flex-wrap:wrap;gap:8px}

    .searchRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .searchRow input{flex:1;min-width:220px}

    .overlay{
      position:fixed;inset:0;z-index:100;
      background:rgba(0,0,0,.70);
      display:none;align-items:center;justify-content:center;
      padding:18px;
    }
    .overlay.show{display:flex}
    .modal{max-width:760px;width:100%;background:linear-gradient(180deg,#191a1f,#101114);border:1px solid var(--line);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,.55)}
    .modal .mhd{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal .mhd b{font-size:14px}
    .modal .mbd{padding:14px}

    .qrBox{
      display:grid;gap:10px;align-content:start;
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.03)
    }
    .qrCanvas{display:grid;place-items:center;background:#fff;border-radius:14px;padding:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .auth{max-width:520px}

    .footerNote{font-size:12px;color:var(--muted);margin-top:12px;line-height:1.35}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">QR</div>
      <div>
        <h1>Gestione riparazioni</h1>
        <div class="sub">Commessa + QR Code + storico</div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tabNew" type="button">Nuova commessa</button>
      <button class="tab" id="tabList" type="button">Storico</button>
      <button class="btn ghost" id="btnSettings" type="button">Impostazioni</button>
      <button class="btn" id="btnLogout" type="button">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="viewNew" class="grid">
    <div class="card">
      <div class="hd">
        <h2>Inserisci una nuova commessa</h2>
        <span class="pill warn" id="pillDraft">IN CORSO</span>
      </div>
      <div class="bd">
        <form id="formNew" autocomplete="off">
          <div class="row two">
            <div>
              <label>Nome e cognome</label>
              <input required name="fullName" placeholder="Es. Mario Rossi" />
            </div>
            <div>
              <label>Telefono</label>
              <input required name="phone" placeholder="Es. 3331234567" />
            </div>
          </div>

          <div class="row two" style="margin-top:12px">
            <div>
              <label>Email</label>
              <input name="email" type="email" placeholder="Es. mario@email.it" />
            </div>
            <div>
              <label>Nome apparecchio</label>
              <input required name="deviceName" placeholder="Es. iPhone, Laptop, Tablet" />
            </div>
          </div>

          <div class="row three" style="margin-top:12px">
            <div>
              <label>Marca</label>
              <input required name="brand" placeholder="Es. Apple" />
            </div>
            <div>
              <label>Modello</label>
              <input required name="model" placeholder="Es. iPhone 12" />
            </div>
            <div>
              <label>Danno</label>
              <input required name="damage" placeholder="Es. Schermo rotto" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Note (modificabili anche dopo)</label>
            <textarea name="notes" placeholder="Inserisci note, accessori lasciati, preventivo, pin, ecc."></textarea>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px">
            <button class="btn primary" type="submit">Crea commessa + QR</button>
            <button class="btn" id="btnReset" type="button">Pulisci campi</button>
            <span class="hint">Dopo la creazione puoi modificarla dallo <b>Storico</b> o aprendo il link dal QR.</span>
          </div>
        </form>
      </div>
    </div>

    <div class="card" id="cardLast" style="display:none">
      <div class="hd">
        <h2>Ultima commessa creata</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn small" id="btnOpenLast" type="button">Apri scheda</button>
          <button class="btn small" id="btnCopyLast" type="button">Copia link</button>
        </div>
      </div>
      <div class="bd" style="display:grid;gap:12px">
        <div class="qrBox">
          <div class="muted" style="font-size:12px">Scansiona per aprire questa commessa</div>
          <div class="qrCanvas"><div id="lastQR"></div></div>
          <div class="mono" id="lastLink" style="font-size:12px;word-break:break-all"></div>
          <div class="hint">Tip: se vuoi stampare, fai screenshot del QR.</div>
        </div>
      </div>
    </div>
  </section>

  <section id="viewList" class="grid" style="display:none">
    <div class="card">
      <div class="hd">
        <h2>Storico commesse</h2>
        <span class="muted" id="jobsCount">0</span>
      </div>
      <div class="bd" style="display:grid;gap:12px">
        <div class="searchRow">
          <input id="search" placeholder="Cerca per nome, telefono, modello, danno..." />
          <select id="filterStatus" style="max-width:200px">
            <option value="all">Tutte</option>
            <option value="open">Solo IN CORSO</option>
            <option value="done">Solo FINITA</option>
          </select>
          <button class="btn" id="btnExport" type="button">Export JSON</button>
          <button class="btn" id="btnImport" type="button">Import</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button class="btn bad" id="btnDangerWipe" type="button">Svuota</button>
        </div>
        <div class="jobs" id="jobs"></div>
        <div class="hint">Nota: i dati sono salvati nel browser (localStorage) su questo dispositivo.</div>
      </div>
    </div>
  </section>
</div>

<!-- AUTH OVERLAY -->
<div class="overlay show" id="authOverlay" aria-modal="true" role="dialog">
  <div class="modal auth">
    <div class="mhd">
      <b id="authTitle">Accesso</b>
      <span class="pill" style="opacity:.85">Offline</span>
    </div>
    <div class="mbd" style="display:grid;gap:12px">
      <div class="hint" id="authHint"></div>
      <div>
        <label id="pwdLabel">Password</label>
        <input id="pwd" type="password" placeholder="Inserisci password" />
      </div>
      <div id="pwd2Box" style="display:none">
        <label>Ripeti password</label>
        <input id="pwd2" type="password" placeholder="Ripeti password" />
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" id="btnAuth" type="button">Entra</button>
        <button class="btn" id="btnAuthMode" type="button">Imposta password</button>
      </div>
      <div class="footerNote">
        Sicurezza: è una protezione semplice lato browser (adatta a uso personale/negozio). Se ti serve accesso multi-dispositivo e vero controllo utenti, serve un backend (es. Firebase).
      </div>
    </div>
  </div>
</div>

<!-- MODAL JOB -->
<div class="overlay" id="jobOverlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="mhd">
      <b id="jobModalTitle">Commessa</b>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn small" id="btnCopyLink" type="button">Copia link</button>
        <button class="btn small" id="btnCloseJob" type="button">Chiudi</button>
      </div>
    </div>
    <div class="mbd" style="display:grid;gap:14px">
      <div class="row two">
        <div class="qrBox">
          <div class="muted" style="font-size:12px">QR Code della commessa</div>
          <div class="qrCanvas"><div id="jobQR"></div></div>
          <div class="mono" id="jobLink" style="font-size:12px;word-break:break-all"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small" id="btnPrintTip" type="button">Tip stampa</button>
            <button class="btn small" id="btnOpenNewTab" type="button">Apri in nuova scheda</button>
          </div>
        </div>
        <div class="card" style="margin:0">
          <div class="hd" style="border-bottom:1px solid var(--line)">
            <h2 style="margin:0;font-size:14px">Stato</h2>
            <span id="jobStatusPill" class="pill warn">IN CORSO</span>
          </div>
          <div class="bd" style="display:grid;gap:10px">
            <div class="hint" id="jobTimes"></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn ok" id="btnMarkDone" type="button">Segna FINITA</button>
              <button class="btn" id="btnMarkOpen" type="button">Segna IN CORSO</button>
              <button class="btn bad" id="btnDeleteJob" type="button">Elimina</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin:0">
        <div class="hd">
          <h2>Dettagli commessa (modificabili)</h2>
        </div>
        <div class="bd">
          <form id="formEdit" autocomplete="off">
            <div class="row two">
              <div>
                <label>Nome e cognome</label>
                <input required name="fullName" />
              </div>
              <div>
                <label>Telefono</label>
                <input required name="phone" />
              </div>
            </div>
            <div class="row two" style="margin-top:12px">
              <div>
                <label>Email</label>
                <input name="email" type="email" />
              </div>
              <div>
                <label>Nome apparecchio</label>
                <input required name="deviceName" />
              </div>
            </div>
            <div class="row three" style="margin-top:12px">
              <div>
                <label>Marca</label>
                <input required name="brand" />
              </div>
              <div>
                <label>Modello</label>
                <input required name="model" />
              </div>
              <div>
                <label>Danno</label>
                <input required name="damage" />
              </div>
            </div>
            <div style="margin-top:12px">
              <label>Note</label>
              <textarea name="notes"></textarea>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px">
              <button class="btn primary" type="submit">Salva modifiche</button>
              <span class="hint">Salvataggio automatico nello storico di questo browser.</span>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/*********************
 * Minimal QR library
 * (QRCode.js - compact build, embedded for offline use)
 *********************/
/*! qrcode.min.js (c) David Shim - MIT License */
(function(){function t(t){this.mode=s.MODE_8BIT_BYTE,this.data=t}function e(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function n(t,e){if(void 0==t.length)throw new Error(t.length+" is not a valid argument");this.totalCount=t,this.dataCount=e}function r(){this.buffer=[],this.length=0}function o(){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}var i={};t.prototype={getLength:function(){return this.data.length},write:function(t){for(var e=0;e<this.data.length;e++){var n=this.data.charCodeAt(e);n<128?t.put(n,8):n<2048?(t.put(192|n>>6,8),t.put(128|63&n,8)):(t.put(224|n>>12,8),t.put(128|n>>6&63,8),t.put(128|63&n,8))}}};for(var a=1;a<41;a++){for(var u=n=function(t,e){return new n(t,e)},c=[],f=0,l=0,s=0;s<4;s++)for(var h=0;h<2;h++){var d=[0,0,0,0];d[s]=h?1:0,c.push(d)}i[a]=[];for(var s=0;s<4;s++){i[a][s]=[];for(var h=0;h<2;h++)i[a][s][h]={}}}
var s={MODE_8BIT_BYTE:1,ERROR_CORRECT_L:1,ERROR_CORRECT_M:0,ERROR_CORRECT_Q:3,ERROR_CORRECT_H:2};
// NOTE: To keep this file compact, we use a lightweight inlined build.
// The following code is a minimized version sufficient for QR generation.
// Source-compatible with QRCode.js API: new QRCode(el, {text, width, height})

// ---- BEGIN Compact QRCode.js implementation ----
// This compact version uses a pre-bundled QR generator (qr.js style).
// For reliability, we embed a proven small generator.

function QRCode(element, options){
  if(typeof element === 'string') element = document.getElementById(element);
  this._el = element;
  this._opts = options || {};
  this.makeCode(this._opts.text || '');
}
QRCode.prototype.clear = function(){ this._el.innerHTML=''; };

// Tiny QR generator adapted from https://github.com/kazuhikoarase/qrcode-generator (MIT)
(function(){
  // We embed the generator in a closure and expose via QRCode._gen
  var QR = {};
  var PAD0 = 0xEC, PAD1 = 0x11;
  var QRMode = {MODE_8BIT_BYTE:1};
  var QRErrorCorrectLevel = {L:1,M:0,Q:3,H:2};

  function QRBitBuffer(){this.buffer=[];this.length=0;}
  QRBitBuffer.prototype={
    get:function(i){var bufIndex=Math.floor(i/8);return ((this.buffer[bufIndex] >>> (7 - i % 8)) & 1) == 1;},
    put:function(num, length){for(var i=0;i<length;i++)this.putBit(((num >>> (length - i - 1)) & 1) == 1);},
    putBit:function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex)this.buffer.push(0);if(bit)this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));this.length++;}
  };

  function QR8bitByte(data){this.mode=QRMode.MODE_8BIT_BYTE;this.data=data;}
  QR8bitByte.prototype={
    getLength:function(){return this.data.length;},
    write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8);}}
  };

  // --- Reed Solomon, polynomials, etc. (condensed) ---
  var QRMath={
    glog:function(n){if(n<1)throw new Error('glog');return QRMath.LOG_TABLE[n];},
    gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n];},
    EXP_TABLE:new Array(256),
    LOG_TABLE:new Array(256)
  };
  for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;
  for(var i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
  for(var i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;

  function QRPolynomial(num, shift){
    var offset=0;while(offset<num.length && num[offset]==0)offset++;
    this.num=new Array(num.length-offset+shift);
    for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset];
  }
  QRPolynomial.prototype={
    get:function(i){return this.num[i];},
    getLength:function(){return this.num.length;},
    multiply:function(e){
      var num=new Array(this.getLength()+e.getLength()-1);
      for(var i=0;i<num.length;i++)num[i]=0;
      for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));
      return new QRPolynomial(num,0);
    },
    mod:function(e){
      if(this.getLength()-e.getLength()<0)return this;
      var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));
      var num=this.num.slice();
      for(var i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);
      return new QRPolynomial(num,0).mod(e);
    }
  };

  function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}

  // RS blocks table (versions 1-10 only; enough for short links, which we use)
  // For our app links, version auto-selection stays within this set.
  var RS_BLOCK_TABLE={
    // typeNumber: {L:[...], M:[...], Q:[...], H:[...]}
    1:{L:[[1,26,19]],M:[[1,26,16]],Q:[[1,26,13]],H:[[1,26,9]]},
    2:{L:[[1,44,34]],M:[[1,44,28]],Q:[[1,44,22]],H:[[1,44,16]]},
    3:{L:[[1,70,55]],M:[[1,70,44]],Q:[[2,35,17]],H:[[2,35,13]]},
    4:{L:[[1,100,80]],M:[[2,50,32]],Q:[[2,50,24]],H:[[4,25,9]]},
    5:{L:[[1,134,108]],M:[[2,67,43]],Q:[[2,33,15],[2,34,16]],H:[[2,33,11],[2,34,12]]},
    6:{L:[[2,86,68]],M:[[4,43,27]],Q:[[4,43,19]],H:[[4,43,15]]},
    7:{L:[[2,98,78]],M:[[4,49,31]],Q:[[2,32,14],[4,33,15]],H:[[4,39,13],[1,40,14]]},
    8:{L:[[2,121,97]],M:[[2,60,38],[2,61,39]],Q:[[4,40,18],[2,41,19]],H:[[4,40,14],[2,41,15]]},
    9:{L:[[2,146,116]],M:[[3,58,36],[2,59,37]],Q:[[4,36,16],[4,37,17]],H:[[4,36,12],[4,37,13]]},
    10:{L:[[2,86,68],[2,87,69]],M:[[4,69,43],[1,70,44]],Q:[[6,43,19],[2,44,20]],H:[[6,43,15],[2,44,16]]}
  };

  function getRSBlocks(typeNumber, errorCorrectLevel){
    var ecKey = (errorCorrectLevel===QRErrorCorrectLevel.L?'L':errorCorrectLevel===QRErrorCorrectLevel.M?'M':errorCorrectLevel===QRErrorCorrectLevel.Q?'Q':'H');
    var table = RS_BLOCK_TABLE[typeNumber] && RS_BLOCK_TABLE[typeNumber][ecKey];
    if(!table) throw new Error('RS_BLOCK_TABLE');
    var list=[];
    for(var i=0;i<table.length;i++){
      var t=table[i];
      var count=t[0], total=t[1], data=t[2];
      for(var j=0;j<count;j++)list.push(new QRRSBlock(total,data));
    }
    return list;
  }

  function getLengthInBits(typeNumber){
    // 8bit mode
    if(typeNumber>=1 && typeNumber<10) return 8;
    return 16;
  }

  function QRCodeModel(typeNumber, errorCorrectLevel){
    this.typeNumber=typeNumber;
    this.errorCorrectLevel=errorCorrectLevel;
    this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[];
  }

  QRCodeModel.prototype={
    addData:function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null;},
    isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col)throw new Error(row+','+col);return this.modules[row][col];},
    getModuleCount:function(){return this.moduleCount;},
    make:function(){
      if(this.typeNumber<1){
        var typeNumber=1;
        for(typeNumber=1;typeNumber<=10;typeNumber++){
          var rsBlocks=getRSBlocks(typeNumber,this.errorCorrectLevel);
          var buffer=new QRBitBuffer();
          for(var i=0;i<this.dataList.length;i++){
            var data=this.dataList[i];
            buffer.put(4,4); // mode
            buffer.put(data.getLength(), getLengthInBits(typeNumber));
            data.write(buffer);
          }
          var totalDataCount=0;
          for(var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount;
          if(buffer.length <= totalDataCount*8) break;
        }
        this.typeNumber=typeNumber;
      }
      this.makeImpl(false, this.getBestMaskPattern());
    },
    makeImpl:function(test, maskPattern){
      this.moduleCount = this.typeNumber * 4 + 17;
      this.modules = new Array(this.moduleCount);
      for(var row=0;row<this.moduleCount;row++){
        this.modules[row] = new Array(this.moduleCount);
        for(var col=0;col<this.moduleCount;col++) this.modules[row][col] = null;
      }
      this.setupPositionProbePattern(0,0);
      this.setupPositionProbePattern(this.moduleCount-7,0);
      this.setupPositionProbePattern(0,this.moduleCount-7);
      this.setupTimingPattern();
      this.setupTypeInfo(test, maskPattern);
      if(this.typeNumber>=2) this.setupPositionAdjustPattern();
      if(this.dataCache==null) this.dataCache = this.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);
      this.mapData(this.dataCache, maskPattern);
    },
    setupPositionProbePattern:function(row,col){
      for(var r=-1;r<=7;r++){
        if(row+r<=-1||this.moduleCount<=row+r) continue;
        for(var c=-1;c<=7;c++){
          if(col+c<=-1||this.moduleCount<=col+c) continue;
          if((0<=r&&r<=6&&(c==0||c==6)) || (0<=c&&c<=6&&(r==0||r==6)) || (2<=r&&r<=4&&2<=c&&c<=4))
            this.modules[row+r][col+c] = true;
          else
            this.modules[row+r][col+c] = false;
        }
      }
    },
    getBestMaskPattern:function(){
      var minLost=1e9,best=0;
      for(var i=0;i<8;i++){
        this.makeImpl(true,i);
        var lost=this.getLostPoint();
        if(lost<minLost){minLost=lost;best=i;}
      }
      return best;
    },
    setupTimingPattern:function(){
      for(var i=8;i<this.moduleCount-8;i++){
        if(this.modules[i][6]!=null) continue;
        this.modules[i][6] = (i%2==0);
        if(this.modules[6][i]!=null) continue;
        this.modules[6][i] = (i%2==0);
      }
    },
    setupPositionAdjustPattern:function(){
      var pos = getPatternPosition(this.typeNumber);
      for(var i=0;i<pos.length;i++){
        for(var j=0;j<pos.length;j++){
          var row=pos[i], col=pos[j];
          if(this.modules[row][col]!=null) continue;
          for(var r=-2;r<=2;r++){
            for(var c=-2;c<=2;c++){
              this.modules[row+r][col+c] = (Math.max(Math.abs(r),Math.abs(c))!=1);
            }
          }
        }
      }
    },
    setupTypeInfo:function(test, maskPattern){
      var data=(this.errorCorrectLevel<<3) | maskPattern;
      var bits=getBCHTypeInfo(data);
      for(var i=0;i<15;i++){
        var mod=!test && ((bits>>i)&1)==1;
        if(i<6) this.modules[i][8]=mod;
        else if(i<8) this.modules[i+1][8]=mod;
        else this.modules[this.moduleCount-15+i][8]=mod;
        if(i<8) this.modules[8][this.moduleCount-i-1]=mod;
        else if(i<9) this.modules[8][15-i-1+1]=mod;
        else this.modules[8][15-i-1]=mod;
      }
      this.modules[this.moduleCount-8][8]=!test;
    },
    mapData:function(data, maskPattern){
      var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;
      for(var col=this.moduleCount-1;col>0;col-=2){
        if(col==6) col--;
        while(true){
          for(var c=0;c<2;c++){
            if(this.modules[row][col-c]==null){
              var dark=false;
              if(byteIndex < data.length) dark = ((data[byteIndex] >>> bitIndex) & 1) == 1;
              var mask = getMask(maskPattern, row, col-c);
              this.modules[row][col-c] = mask ? !dark : dark;
              bitIndex--;
              if(bitIndex==-1){byteIndex++;bitIndex=7;}
            }
          }
          row += inc;
          if(row<0 || this.moduleCount<=row){row -= inc; inc = -inc; break;}
        }
      }
    },
    createData:function(typeNumber, errorCorrectLevel, dataList){
      var rsBlocks=getRSBlocks(typeNumber,errorCorrectLevel);
      var buffer=new QRBitBuffer();
      for(var i=0;i<dataList.length;i++){
        var data=dataList[i];
        buffer.put(4,4);
        buffer.put(data.getLength(), getLengthInBits(typeNumber));
        data.write(buffer);
      }
      var totalDataCount=0;
      for(var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount;
      if(buffer.length > totalDataCount*8) throw new Error('code length overflow');
      if(buffer.length + 4 <= totalDataCount*8) buffer.put(0,4);
      while(buffer.length%8!=0) buffer.putBit(false);
      while(true){
        if(buffer.length >= totalDataCount*8) break;
        buffer.put(PAD0,8);
        if(buffer.length >= totalDataCount*8) break;
        buffer.put(PAD1,8);
      }
      return createBytes(buffer, rsBlocks);
    },
    getLostPoint:function(){
      var lost=0;
      // Level 1
      for(var row=0;row<this.moduleCount;row++){
        for(var col=0;col<this.moduleCount;col++){
          var same=0, dark=this.isDark(row,col);
          for(var r=-1;r<=1;r++){
            if(row+r<0||this.moduleCount<=row+r) continue;
            for(var c=-1;c<=1;c++){
              if(col+c<0||this.moduleCount<=col+c) continue;
              if(r==0&&c==0) continue;
              if(dark==this.isDark(row+r,col+c)) same++;
            }
          }
          if(same>5) lost += (3 + same - 5);
        }
      }
      // Level 2
      for(var row=0;row<this.moduleCount-1;row++){
        for(var col=0;col<this.moduleCount-1;col++){
          var count=0;
          if(this.isDark(row,col)) count++;
          if(this.isDark(row+1,col)) count++;
          if(this.isDark(row,col+1)) count++;
          if(this.isDark(row+1,col+1)) count++;
          if(count==0 || count==4) lost += 3;
        }
      }
      // Level 4
      var darkCount=0;
      for(var col=0;col<this.moduleCount;col++) for(var row=0;row<this.moduleCount;row++) if(this.isDark(row,col)) darkCount++;
      var ratio = Math.abs(100*darkCount/this.moduleCount/this.moduleCount - 50) / 5;
      lost += ratio*10;
      return lost;
    }
  };

  function getBCHTypeInfo(data){
    var d = data << 10;
    while(getBCHDigit(d) - getBCHDigit(0x537) >= 0) d ^= (0x537 << (getBCHDigit(d) - getBCHDigit(0x537)));
    return ((data<<10) | d) ^ 0x5412;
  }
  function getBCHDigit(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;}
  function getMask(maskPattern, i, j){
    switch(maskPattern){
      case 0: return (i + j) % 2 == 0;
      case 1: return i % 2 == 0;
      case 2: return j % 3 == 0;
      case 3: return (i + j) % 3 == 0;
      case 4: return (Math.floor(i/2) + Math.floor(j/3)) % 2 == 0;
      case 5: return (i*j) % 2 + (i*j) % 3 == 0;
      case 6: return ((i*j) % 2 + (i*j) % 3) % 2 == 0;
      case 7: return ((i*j) % 3 + (i + j) % 2) % 2 == 0;
      default: throw new Error('bad maskPattern');
    }
  }
  function getPatternPosition(typeNumber){
    // Versions 1-10 positions
    var PATTERN_POS=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]];
    return PATTERN_POS[typeNumber] || [];
  }
  function createBytes(buffer, rsBlocks){
    var offset=0;
    var maxDc=0, maxEc=0;
    var dcdata=new Array(rsBlocks.length);
    var ecdata=new Array(rsBlocks.length);
    for(var r=0;r<rsBlocks.length;r++){
      var dcCount=rsBlocks[r].dataCount;
      var ecCount=rsBlocks[r].totalCount - dcCount;
      maxDc = Math.max(maxDc, dcCount);
      maxEc = Math.max(maxEc, ecCount);
      dcdata[r]=new Array(dcCount);
      for(var i=0;i<dcdata[r].length;i++) dcdata[r][i]=0xff & buffer.buffer[i+offset];
      offset += dcCount;
      var rsPoly=getErrorCorrectPolynomial(ecCount);
      var rawPoly=new QRPolynomial(dcdata[r], rsPoly.getLength()-1);
      var modPoly=rawPoly.mod(rsPoly);
      ecdata[r]=new Array(rsPoly.getLength()-1);
      for(var i=0;i<ecdata[r].length;i++){
        var modIndex=i + modPoly.getLength() - ecdata[r].length;
        ecdata[r][i] = (modIndex>=0)?modPoly.get(modIndex):0;
      }
    }
    var totalCodeCount=0;
    for(var i=0;i<rsBlocks.length;i++) totalCodeCount += rsBlocks[i].totalCount;
    var data=new Array(totalCodeCount);
    var index=0;
    for(var i=0;i<maxDc;i++) for(var r=0;r<rsBlocks.length;r++) if(i<dcdata[r].length) data[index++] = dcdata[r][i];
    for(var i=0;i<maxEc;i++) for(var r=0;r<rsBlocks.length;r++) if(i<ecdata[r].length) data[index++] = ecdata[r][i];
    return data;
  }
  function getErrorCorrectPolynomial(errorCorrectLength){
    var a=new QRPolynomial([1],0);
    for(var i=0;i<errorCorrectLength;i++) a=a.multiply(new QRPolynomial([1, QRMath.gexp(i)],0));
    return a;
  }

  function toCanvas(model, size){
    var count=model.getModuleCount();
    var cell=Math.floor(size/count);
    var margin=Math.max(4, Math.floor((size - cell*count)/2));
    var canvas=document.createElement('canvas');
    canvas.width = canvas.height = size;
    var ctx=canvas.getContext('2d');
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,size,size);
    ctx.fillStyle='#000000';
    for(var r=0;r<count;r++){
      for(var c=0;c<count;c++){
        if(model.isDark(r,c)) ctx.fillRect(margin + c*cell, margin + r*cell, cell, cell);
      }
    }
    return canvas;
  }

  QR.make = function(text, size){
    // Choose a version that fits (1-10) and level M.
    var model=new QRCodeModel(0, QRErrorCorrectLevel.M);
    model.addData(text);
    model.make();
    return toCanvas(model, size||220);
  };

  QRCode.prototype.makeCode = function(text){
    this.clear();
    if(!text){return;}
    var size = this._opts.width || 220;
    var canvas = QR.make(text, size);
    this._el.appendChild(canvas);
  };
})();
// ---- END compact QR implementation ----
</script>

<script>
/*********************
 * App logic
 *********************/
const LS_JOBS = 'repairJobsV1';
const LS_PWDH = 'repairPwdHashV1';
const SS_AUTH = 'repairAuthedV1';

const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

function nowISO(){return new Date().toISOString();}
function fmt(dt){
  const d = new Date(dt);
  return d.toLocaleString('it-IT', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function uid(){
  // short, URL-friendly
  return 'J' + Math.random().toString(36).slice(2, 8).toUpperCase() + '-' + Date.now().toString(36).toUpperCase();
}

async function sha256(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function loadJobs(){
  try{ return JSON.parse(localStorage.getItem(LS_JOBS) || '[]'); }catch(e){ return []; }
}
function saveJobs(jobs){ localStorage.setItem(LS_JOBS, JSON.stringify(jobs)); }

function baseURL(){
  // current page without hash
  // NOTE: if you run the app as a local file (file://), the full path can be very long
  // and may prevent QR generation in some QR libraries. In that case we fallback to
  // a short relative URL so the QR is still generated.
  if(location.protocol === 'file:') return 'index.html';
  return location.href.split('#')[0];
}
function jobLink(id){
  return baseURL() + '#job=' + encodeURIComponent(id);
}

// --------- Views
const tabNew = $('#tabNew');
const tabList = $('#tabList');
const viewNew = $('#viewNew');
const viewList = $('#viewList');

function setTab(which){
  if(which==='new'){
    tabNew.classList.add('active');
    tabList.classList.remove('active');
    viewNew.style.display='grid';
    viewList.style.display='none';
  } else {
    tabList.classList.add('active');
    tabNew.classList.remove('active');
    viewList.style.display='grid';
    viewNew.style.display='none';
    renderJobs();
  }
}

// --------- Auth
const authOverlay = $('#authOverlay');
const authTitle = $('#authTitle');
const authHint = $('#authHint');
const btnAuth = $('#btnAuth');
const btnAuthMode = $('#btnAuthMode');
const pwd = $('#pwd');
const pwd2 = $('#pwd2');
const pwd2Box = $('#pwd2Box');

let authMode = 'login'; // or setup

function hasPassword(){ return !!localStorage.getItem(LS_PWDH); }

function showAuth(){
  authOverlay.classList.add('show');
  pwd.value=''; pwd2.value='';
  if(hasPassword()){
    authMode='login';
    authTitle.textContent='Accesso';
    authHint.textContent='Inserisci la password per accedere.';
    btnAuth.textContent='Entra';
    btnAuthMode.textContent='Reimposta password';
    pwd2Box.style.display='none';
  } else {
    authMode='setup';
    authTitle.textContent='Imposta password';
    authHint.textContent='Prima volta: imposta una password per proteggere l\'app.';
    btnAuth.textContent='Salva password';
    btnAuthMode.textContent='Ho gia una password';
    pwd2Box.style.display='block';
  }
}

function hideAuth(){
  authOverlay.classList.remove('show');
}

btnAuthMode.addEventListener('click', ()=>{
  if(!hasPassword()){
    // from setup screen, switch to login only if password exists
    authMode='login';
  }
  if(authMode==='login'){
    authMode='setup';
    authTitle.textContent='Reimposta password';
    authHint.textContent='Inserisci una nuova password (la vecchia verrà sostituita).';
    btnAuth.textContent='Salva password';
    btnAuthMode.textContent='Torna al login';
    pwd2Box.style.display='block';
  } else {
    authMode='login';
    authTitle.textContent='Accesso';
    authHint.textContent='Inserisci la password per accedere.';
    btnAuth.textContent='Entra';
    btnAuthMode.textContent= hasPassword() ? 'Reimposta password' : 'Imposta password';
    pwd2Box.style.display='none';
  }
  pwd.value=''; pwd2.value='';
});

btnAuth.addEventListener('click', async ()=>{
  const p1 = (pwd.value||'').trim();
  const p2 = (pwd2.value||'').trim();
  if(authMode==='setup'){
    if(p1.length<4){ alert('Password troppo corta (min 4 caratteri).'); return; }
    if(p1!==p2){ alert('Le password non coincidono.'); return; }
    const h = await sha256(p1);
    localStorage.setItem(LS_PWDH, h);
    sessionStorage.setItem(SS_AUTH, '1');
    hideAuth();
    routeFromHash();
    return;
  }
  // login
  if(!hasPassword()){
    authMode='setup'; showAuth(); return;
  }
  const h = await sha256(p1);
  const saved = localStorage.getItem(LS_PWDH);
  if(h!==saved){ alert('Password errata.'); return; }
  sessionStorage.setItem(SS_AUTH, '1');
  hideAuth();
  routeFromHash();
});

$('#btnLogout').addEventListener('click', ()=>{
  sessionStorage.removeItem(SS_AUTH);
  showAuth();
});

$('#btnSettings').addEventListener('click', ()=>{
  alert(
    'Impostazioni rapide:\n\n- Password: usa "Reimposta password" nella schermata di accesso.\n- Backup: vai su Storico > Export JSON.\n- Nota: i dati restano sul browser di questo dispositivo.'
  );
});

function ensureAuth(){
  if(sessionStorage.getItem(SS_AUTH)==='1') return true;
  showAuth();
  return false;
}

// --------- New job
const formNew = $('#formNew');
const btnReset = $('#btnReset');
const cardLast = $('#cardLast');
const lastQR = $('#lastQR');
const lastLink = $('#lastLink');
const btnOpenLast = $('#btnOpenLast');
const btnCopyLast = $('#btnCopyLast');

let lastCreatedId = null;

btnReset.addEventListener('click', ()=>{ formNew.reset(); });

formNew.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!ensureAuth()) return;
  const fd = new FormData(formNew);
  const job = {
    id: uid(),
    status: 'IN CORSO',
    createdAt: nowISO(),
    updatedAt: nowISO(),
    fullName: (fd.get('fullName')||'').trim(),
    phone: (fd.get('phone')||'').trim(),
    email: (fd.get('email')||'').trim(),
    deviceName: (fd.get('deviceName')||'').trim(),
    brand: (fd.get('brand')||'').trim(),
    model: (fd.get('model')||'').trim(),
    damage: (fd.get('damage')||'').trim(),
    notes: (fd.get('notes')||'').trim(),
  };
  const jobs = loadJobs();
  jobs.unshift(job);
  saveJobs(jobs);
  lastCreatedId = job.id;
  formNew.reset();
  showLast(job.id);
});

function showLast(id){
  cardLast.style.display='block';
  const link = jobLink(id);
  lastLink.textContent = link;
  lastQR.innerHTML='';
  new QRCode(lastQR, {text: link, width: 240, height: 240});
  btnOpenLast.onclick = ()=> openJob(id);
  btnCopyLast.onclick = async ()=>{ await navigator.clipboard.writeText(link); toast('Link copiato'); };
  // jump to last card
  cardLast.scrollIntoView({behavior:'smooth', block:'start'});
}

// --------- Jobs list
const jobsEl = $('#jobs');
const jobsCount = $('#jobsCount');
const search = $('#search');
const filterStatus = $('#filterStatus');

search.addEventListener('input', ()=>renderJobs());
filterStatus.addEventListener('change', ()=>renderJobs());

function renderJobs(){
  const jobs = loadJobs();
  const q = (search.value||'').trim().toLowerCase();
  const f = filterStatus.value;
  let list = jobs;

  if(f==='open') list = list.filter(j=>j.status!=='FINITA');
  if(f==='done') list = list.filter(j=>j.status==='FINITA');

  if(q){
    list = list.filter(j=>{
      const hay = [j.id,j.fullName,j.phone,j.email,j.deviceName,j.brand,j.model,j.damage,j.notes].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  jobsCount.textContent = `${list.length} / ${jobs.length}`;
  jobsEl.innerHTML='';

  if(list.length===0){
    const empty = document.createElement('div');
    empty.className='hint';
    empty.textContent = jobs.length===0 ? 'Nessuna commessa ancora. Creane una dalla sezione "Nuova commessa".' : 'Nessun risultato con questi filtri.';
    jobsEl.appendChild(empty);
    return;
  }

  for(const j of list){
    const card = document.createElement('div');
    card.className='job';

    const pillClass = (j.status==='FINITA') ? 'pill ok' : 'pill warn';

    card.innerHTML = `
      <div class="jobTop">
        <div>
          <div class="jobTitle">${escapeHTML(j.fullName)} <span class="muted" style="font-weight:800">(${escapeHTML(j.phone)})</span></div>
          <div class="jobMeta">
            <div><b>${escapeHTML(j.deviceName)}</b> - ${escapeHTML(j.brand)} ${escapeHTML(j.model)}</div>
            <div>Danno: ${escapeHTML(j.damage)}</div>
            <div>Creata: ${fmt(j.createdAt)} | Agg.: ${fmt(j.updatedAt)}</div>
          </div>
        </div>
        <div><span class="${pillClass}">${escapeHTML(j.status)}</span></div>
      </div>
      <div class="jobActions">
        <button class="btn small" data-act="open" data-id="${j.id}">Apri / Modifica</button>
        <button class="btn small" data-act="qr" data-id="${j.id}">QR</button>
        <button class="btn small" data-act="toggle" data-id="${j.id}">${j.status==='FINITA'?'Segna IN CORSO':'Segna FINITA'}</button>
        <button class="btn small bad" data-act="del" data-id="${j.id}">Elimina</button>
      </div>
    `;
    jobsEl.appendChild(card);
  }
}

jobsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  if(!id) return;

  if(act==='open') openJob(id);
  if(act==='qr') showJobModal(id, true);
  if(act==='toggle') toggleStatus(id);
  if(act==='del') deleteJob(id);
});

function toggleStatus(id){
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j) return;
  j.status = (j.status==='FINITA') ? 'IN CORSO' : 'FINITA';
  j.updatedAt = nowISO();
  saveJobs(jobs);
  renderJobs();
  toast('Aggiornato');
}

function deleteJob(id){
  if(!confirm('Eliminare questa commessa?')) return;
  const jobs = loadJobs().filter(j=>j.id!==id);
  saveJobs(jobs);
  renderJobs();
  toast('Eliminata');
}

// --------- Export / wipe
$('#btnExport').addEventListener('click', ()=>{
  const jobs = loadJobs();
  const blob = new Blob([JSON.stringify({exportedAt: nowISO(), jobs}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url;
  a.download = `commesse_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

$('#btnDangerWipe').addEventListener('click', ()=>{
  if(!confirm('ATTENZIONE: svuotare TUTTE le commesse?')) return;
  if(!confirm('Conferma di nuovo: questa azione non si annulla.')) return;
  saveJobs([]);
  renderJobs();
  toast('Storico svuotato');
});

// --------- Job modal
const jobOverlay = $('#jobOverlay');
const jobModalTitle = $('#jobModalTitle');
const jobQR = $('#jobQR');
const jobLinkEl = $('#jobLink');
const jobTimes = $('#jobTimes');
const jobStatusPill = $('#jobStatusPill');
const formEdit = $('#formEdit');
const btnCloseJob = $('#btnCloseJob');
const btnCopyLink = $('#btnCopyLink');
const btnMarkDone = $('#btnMarkDone');
const btnMarkOpen = $('#btnMarkOpen');
const btnDeleteJob = $('#btnDeleteJob');

let currentJobId = null;

btnCloseJob.addEventListener('click', closeJob);
jobOverlay.addEventListener('click', (e)=>{ if(e.target===jobOverlay) closeJob(); });

$('#btnOpenNewTab').addEventListener('click', ()=>{
  if(!currentJobId) return;
  window.open(jobLink(currentJobId), '_blank');
});

$('#btnPrintTip').addEventListener('click', ()=>{
  alert('Tip stampa veloce:\n\n1) Apri questa scheda sul telefono\n2) Fai screenshot del QR\n3) Stampa lo screenshot (o salvalo per WhatsApp)\n\nIl QR contiene un link alla commessa.');
});

btnCopyLink.addEventListener('click', async ()=>{
  if(!currentJobId) return;
  const link = jobLink(currentJobId);
  await navigator.clipboard.writeText(link);
  toast('Link copiato');
});

btnMarkDone.addEventListener('click', ()=>{ if(currentJobId){ setStatus(currentJobId,'FINITA'); } });
btnMarkOpen.addEventListener('click', ()=>{ if(currentJobId){ setStatus(currentJobId,'IN CORSO'); } });
btnDeleteJob.addEventListener('click', ()=>{ if(currentJobId){ deleteJob(currentJobId); closeJob(); } });

function setStatus(id, status){
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j) return;
  j.status=status;
  j.updatedAt=nowISO();
  saveJobs(jobs);
  showJobModal(id, false);
  renderJobs();
}

function openJob(id){
  setTab('list');
  showJobModal(id, false);
}

function closeJob(){
  jobOverlay.classList.remove('show');
  currentJobId = null;
  // clear hash if it was a job route
  if(location.hash.startsWith('#job=')) history.replaceState(null,'', baseURL() + '#');
}

function showJobModal(id, focusQR){
  if(!ensureAuth()) return;
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===id);
  if(!j){ alert('Commessa non trovata in questo dispositivo.'); return; }

  currentJobId = id;
  jobModalTitle.textContent = `Commessa ${id}`;

  const link = jobLink(id);
  jobLinkEl.textContent = link;
  jobQR.innerHTML='';
  new QRCode(jobQR, {text: link, width: 240, height: 240});

  jobTimes.textContent = `Creata: ${fmt(j.createdAt)}  |  Ultimo aggiornamento: ${fmt(j.updatedAt)}`;
  jobStatusPill.textContent = j.status;
  jobStatusPill.className = (j.status==='FINITA') ? 'pill ok' : 'pill warn';

  // fill form
  formEdit.fullName.value = j.fullName || '';
  formEdit.phone.value = j.phone || '';
  formEdit.email.value = j.email || '';
  formEdit.deviceName.value = j.deviceName || '';
  formEdit.brand.value = j.brand || '';
  formEdit.model.value = j.model || '';
  formEdit.damage.value = j.damage || '';
  formEdit.notes.value = j.notes || '';

  jobOverlay.classList.add('show');
  if(focusQR) jobQR.scrollIntoView({behavior:'smooth', block:'center'});
}

formEdit.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!currentJobId) return;
  const jobs = loadJobs();
  const j = jobs.find(x=>x.id===currentJobId);
  if(!j) return;

  j.fullName = formEdit.fullName.value.trim();
  j.phone = formEdit.phone.value.trim();
  j.email = formEdit.email.value.trim();
  j.deviceName = formEdit.deviceName.value.trim();
  j.brand = formEdit.brand.value.trim();
  j.model = formEdit.model.value.trim();
  j.damage = formEdit.damage.value.trim();
  j.notes = formEdit.notes.value.trim();
  j.updatedAt = nowISO();

  // move to top (most recent update)
  const idx = jobs.findIndex(x=>x.id===currentJobId);
  if(idx>-1){
    const [item] = jobs.splice(idx,1);
    jobs.unshift(item);
  }
  saveJobs(jobs);
  renderJobs();
  showJobModal(currentJobId, false);
  toast('Salvato');
});

// --------- Router from QR hash
function parseHash(){
  const h = location.hash || '';
  if(!h.startsWith('#job=')) return null;
  return decodeURIComponent(h.slice(5));
}

function routeFromHash(){
  const id = parseHash();
  if(!id) return;
  // open modal on list view
  setTab('list');
  showJobModal(id, true);
}

window.addEventListener('hashchange', ()=>{ if(sessionStorage.getItem(SS_AUTH)==='1') routeFromHash(); });

// --------- Utilities
function escapeHTML(str){
  return (str||'').replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m] || m));
}

let toastTO=null;
function toast(msg){
  clearTimeout(toastTO);
  let el = document.getElementById('toast');
  if(!el){
    el=document.createElement('div');
    el.id='toast';
    el.style.position='fixed';
    el.style.left='50%';
    el.style.bottom='18px';
    el.style.transform='translateX(-50%)';
    el.style.padding='10px 12px';
    el.style.borderRadius='999px';
    el.style.background='rgba(0,0,0,.75)';
    el.style.border='1px solid rgba(255,255,255,.12)';
    el.style.color='#fff';
    el.style.fontWeight='800';
    el.style.fontSize='13px';
    el.style.zIndex='999';
    el.style.backdropFilter='blur(10px)';
    document.body.appendChild(el);
  }
  el.textContent=msg;
  el.style.opacity='1';
  toastTO=setTimeout(()=>{el.style.opacity='0';}, 1400);
}

// --------- Init
// tabs
 tabNew.addEventListener('click', ()=>setTab('new'));
 tabList.addEventListener('click', ()=>setTab('list'));

(function init(){
  // Fix potential broken state if any
  try{
    // Show auth if not authed
    if(sessionStorage.getItem(SS_AUTH) !== '1') showAuth();
    else hideAuth();
  } catch(e){
    showAuth();
  }

  renderJobs();
  // If direct job link
  if(sessionStorage.getItem(SS_AUTH) === '1') routeFromHash();
})();
</script>
</body>
</html>
